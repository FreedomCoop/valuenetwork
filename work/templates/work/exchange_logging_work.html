{% extends "work_base.html" %}

{% load staticfiles %}
{% load i18n %}
{% load bootstrap_tags %}
{% load filters %}

{% block head_title %}{% trans "Exchange" %}: {{ exchange }}{% endblock %}

{% block extra_head %}

<link rel="stylesheet" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="{% static 'css/chosen.css' %}" />

<style>

div p:last-child {
    margin-bottom: 2px;
}

form[id^='xferForm'] div[id*='_ocp_resource_type_chzn'] {
  float: left;
}
.add-new-type {
  display: table;
  padding-left: 1em;
}

.event {
    padding: 4px 0;
    margin-left: 1em;
}
.btn {
    margin-left: 10px;
}
h3, h4 {
    /*color: firebrick;*/
    margin-bottom: 3px;
}
.modal {
    width: 600px;
}
.subsection-label {
    font-weight: bold;
}
.detail-line {
    margin: 0 0 0 2em;
}
li {
    list-style-type: none;
}
.event-label {
    color: #476B6B; /*#BE6F54;*/
    font-weight: bold;
    font-style: normal;
}
.hdg {
    font-weight: bold;
    font-size: 1.1em;
    color: #7D1818;
}
.onhand, .indent {
    margin-left: 3em;
}
.unplanned {
    color: 	#7D1818;
}
#exchangeForm #id_notes, #exchangeForm #id_url, #exchangeForm #id_start_date {
    width: 97%; /*328px;*/
}
.notes {
    padding-right: 2em;
    font-style: italic;
    margin: 0px 0 7px 2em;
}
.total {
    float: right;
    color: #333;
    font-size: 10pt;
    margin-bottom: 0;
    margin-top: 2px;
}
.info {
    float: right;
    margin-left: 5px;
}
.btn-mini {
    margin-top: 1px;
    margin-bottom: 1px;
}
.item-description {
    height: 40px;
    width: 328px;
}
.totals {
    /*border: solid 2px firebrick;
    background-color: oldlace;*/
    margin-bottom: 12px;
  padding-bottom: 12px;
  padding-top: 11px;
    /*padding-left: 1em;*/
}
.total-top {
    font-weight: bold;
    padding-right: 2em;
}
.bold {
    font-weight: bold;
}
.commitment {
    margin-left: 1em;
}

.log-section {
    /*border: solid 1px gainsboro;*/
    background-color: beige;
    /*padding: 4px;*/
  margin-bottom: 8px;
  padding: 5px 15px;
}
.trt {
    /*border: solid 1px gainsboro;
    background-color: lightyellow;
    padding: 4px;
    margin-bottom: 7px;*/
  padding: 5px 15px;
  margin-bottom: 13px;
  /*background-color: #f0f0da;
  border: 1px solid #CACAC6;
  -moz-border-radius: 7px;
  -webkit-border-radius: 7px;
  border-radius: 7px;*/
}
h3.trtheading {
    color: #888;
    /*font-style: italic;
    font-weight: normal;*/
    font-size: 1.19em;
}
.ce {
    margin-left: 2em;
    margin-top: 3px;
}
.modal-hdg {
    font-weight: bold;
    color: green;
    font-size: 1.1em;
}
.chzn-container .chzn-results li {
  padding: 3px 6px 6px;
}
</style>

{% endblock %}

{% block body_class %}exchange{% endblock %}

{% block body_base %}
<div class="container">
    {% include "_messages.html" %}
	<div>
	<legend>
    <span style="/*font-size:90%;*/">
    <a href="{% url 'members_agent' agent_id=context_agent.id %}">{{ context_agent.name }}</a> > <a href="{% url "exchanges_all" agent_id=context_agent.id %}">{% trans "Exchanges" %}</a> >
      {% if exchange %}
         <span style="">{{ exchange|show_name:context_agent|safe }}</span>
      {% else %}
        {% trans "New" %} {{ exchange_type.name }}
      {% endif %}
      <!-- <span style="font-size:85%; color:#555;">for {{ context_agent.name }}</span> -->
    </span>
{% comment %}
        {% if exchange.order %}
            <form
                style="display: inline;"
                id="order"
                action="{% url "order_plan" order_id=exchange.order.id %}"
                method="GET" >
                <button style="display: inline;"  class="btn btn-info" title="Order for this sale" >{% trans 'Go to Order' %}</button>
            </form>
        {% endif %}
{% endcomment %}
        <div class="subnav">
            {% if request.user.agent.agent in context_agent.managers or request.user.agent.agent == context_agent %}
              {% if context_agent.faircoin_resource %}
                <a class="indent" href="{% url "manage_faircoin_account" resource_id=context_agent.faircoin_resource.id %}">{% trans "Wallet" %}</a>
              {% endif %}
            {% endif %}
            <!-- <a class="indent" href="{% url "exchanges_all" agent_id=context_agent.id %}">{% trans "All Exchanges" %}</a>
            <a class="indent" href="{% url 'members_agent' agent_id=context_agent.id %}">{% trans "View Project" %}</a> -->
            <a class="indent" href="{% url "your_projects" %}">{% trans "Your Projects" %}</a>
        </div>
	</legend>

	<div class="row-fluid">

        <div class="span4">
            <div class="totals infobox">
                {% if exchange.status %}
                    <p>
                      {% trans "Status" %}: <span class="{{ exchange.status }}">{{ exchange.status|title }}</span> &nbsp;
                        {% if exchange.context_agent and request.user.is_superuser %}
                            {% trans "Context" %}: <a href="{% url "members_agent" agent_id=exchange.context_agent.id %}"
                           style="">{{ exchange.context_agent.name }}</a>
                        {% endif %}
                    </p>
                {% endif %}
                {% with exchange.join_request as req %}
                {% if req %}
                    <p>
                        {% trans "Related request" %}:
                        {% if context_agent == req.agent %}
                            <a href="{% url "project_feedback" agent_id=req.agent.id join_request_id=req.id %}"
                               style="font-weight:bold; font-size:1.2em;">
                        {% else %}
                            <a href="{% url "project_feedback" agent_id=req.project.agent.id join_request_id=req.id %}"
                               style="font-weight:bold; font-size:1.2em;">
                        {% endif %}
                            {% trans "Feedback" %}</a>
                        ({{ req.state }})
                    </p>
                    <p>
                    {% if context_agent == req.project.agent %} {% trans "From" %}:
                        <a href="{% url "members_agent" agent_id=req.agent.id %}"
                           style="font-weight:bold; font-size:1.2em;">{{ req.agent.name }}</a>
                    {% else %} {% trans "To" %}:
                        <a href="{% url "members_agent" agent_id=req.project.agent.id %}"
                           style="font-weight:bold; font-size:1.2em;">{{ req.project.agent.name }}</a>
                    {% endif %}
                    </p>
                    {% if req.payment_gateway %}
                        <p>
                            {% trans "Payment gateway" %}: <b>{{ req.payment_gateway }}</b>
                        </p>
                    {% endif %}
                    {% if req.payment_amount %}
                        {% if req.project.shares_type %}
                            <p>
                                {% trans "Item" %}: <b>{{ req.project.shares_type }}</b>
                                ({{ req.show_share_price }})
                            </p>
                        {% endif %}
                        <p>
                            {% trans "Quantity" %}: <b>{{ req.payment_amount }}</b> &nbsp;
                            {% if req.total_shares %}
                              {% if req.pending_shares %}
                                ( <span class="complete">{{ req.total_shares }} {% trans "owned" %}</span> /
                                    <span class="pending">{{ req.pending_shares }} {% trans "pending" %}</span> )
                              {% else %}
                                <span class="complete">{% trans "owned" %}</span>
                              {% endif %}
                            {% else %}
                              <!-- <b class="pending">{% trans "pending" %}</b> -->
                            {% endif %}
                        </p>
                        <p>
                            {% trans "Total" %}: <b>{{ req.show_total_price }}</b>
                            {% with req.payment_pending_amount as pendamo %}
                            {% if pendamo %} &nbsp;
                                {% if pendamo|lower == req.total_price|lower %}
                                    <b class="error">{% trans "pending" %}</b>
                                {% else %}
                                    {% trans "Pending" %}: <b class="error">{{ pendamo }}
                                    {{ req.show_payment_unit }}</b>
                                {% endif %}
                                {% if req.agent.faircoin_resource and request.user.agent.agent in req.agent.managers %}
                                    <a href="{% url 'manage_faircoin_account' resource_id=req.agent.faircoin_resource.id %}"
                                       class='btn btn-primary btn-mini'>
                                        {% trans "Faircoin account" %}</a>
                                {% endif %}
                            {% endif %}
                            {% endwith %}
                        </p>
                    {% endif %}

                {% else %}
                    <p>
                        {% trans "With Agents:" %}
                        {% for ag in total_agents %}
                            {% if ag and not ag == context_agent %}
                                <a href="{% url "members_agent" agent_id=ag.id %}"
                                   style="font-weight:bold; font-size:1.2em;">{{ ag.name }}</a> &nbsp;
                            {% endif %}
                        {% endfor %}
                    </p>
                {% endif %}
                {% endwith %}
                <p>
                    {% trans "Total transfered value" %}: <span class="total-top">{{ total_t }}
                    {% if total_t %}{% if total_t_unit.symbol %}{{ total_t_unit.symbol }}{% else %}{{ total_t_unit.abbrev }}{% endif %}{% endif %}</span>
                </p>
                <p>
                    {% trans "Total reciprocal transfered value" %}: <span class="total-top">{{ total_rect }}
                    {% if total_rect %}{% if total_rect_unit.symbol %}{{ total_rect_unit.symbol }}{% else %}{{ total_rect_unit.abbrev }}{% endif %}{% endif %}</span>
                </p>
                {% if request.user.is_superuser %}
                  <p>
                    <em>logger: {{ logger }} &nbsp; (tts:{% for tt in exchange.exchange_type.transfer_types.all %}{{ tt.id }},{% endfor %} txs:{{ exchange.transfers.all|length }}, coms:{{ exchange.commitments.all|length }}, evts:{{ exchange.events.all|length }})</em><br>
                    {% for tx in exchange.transfers.all %}
                      tx:{{ tx.id }}(tt:{{ tx.transfer_type.id }})-co:{{ tx.commitments.all|length }}-ev:{{ tx.events.all|length }}-reci:{{ tx.is_reciprocal }}<br> {% endfor %}
                  </p>
                  <p>
                    <em>notes: {{ exchange.notes }}</em>
                  </p>
                {% endif %}
            </div>
            {% if not exchange.join_request.agent == request.user.agent.agent and logger %}
            <form class="validateMe miniform" id="exchangeForm" method="POST" action="" style="padding-bottom:13px;">
                {% csrf_token %}
                {{ exchange_form|as_bootstrap }}
                {% if agent %}
                    <!-- <div class="form-actions"> -->
                        <input type="submit" name="save" value="{% trans 'Save changes' %}" class="btn btn-primary" />
                    <!-- </div> -->
                    {% if not exchange %}
                        <p>Enter this information, click on Save changes, then you can enter the exchange detail.</p>
                    {% endif %}
                {% endif %}
            </form>
            {% endif %}

        </div>

        {% with slots|first as tt %}
        <div class="span8">
          {% if exchange %}
            {% if True or exchange.exchange_type.transfer_types.count > 1 or tt and not tt.is_income %}
            <div class="trt infobox">
                <h3 class="trtheading">{% trans "Outgoing Transfers" %}
                {% if logger %}<span class="info"> <a href="#" id="xfer-info" data-toggle="popover" data-trigger='hover' title="Transfers" data-placement="left"
                    data-content="Log the planned and actual transfers for this exchange.  The types of transfers are determined by the type of exchange,
                    as defined by your previous selections.">
                    <img src="{% static 'img/information-icon.png' %}" /></a>
                </span>
                {% endif %}
                </h3>
                {% for slot in slots %}
                    {% if not slot.is_income %}
                        <div class="log-section infobox2">
                            <h3>
                                {{ slot|show_name:context_agent|safe }}
                                {% if agent and exchange and logger %}
                                    <a href="#addCommitModal{{ slot.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log a new commitment or plan for a transfer" >
                                        {% trans "New Commitment" %}
                                    </a>
                                    {% if not slot.is_currency %}
                                      <a href="#addTransferModal{{ slot.id }}" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Log a new transfer without a commitment or plan" >
                                        {% trans "New Transfer" %}
                                    </a>
                                    {% endif %}
                                {% endif %}
                                {% if request.user.is_superuser and slot.add_xfer_form.errors %}<br>
                                  errors: {{ slot.add_xfer_form.errors }}
                                {% endif %}

                            </h3>
                            <p style="total">{% trans "Status" %}: <span class="{{ slot.status }}">{{ slot.status|title }}</span> &nbsp; &nbsp;
                                Total: {{ slot.total }}
                                {% if exchange.join_request and slot.is_currency %}{{ exchange.join_request.show_payment_unit }}
                                {% elif slot.total_unit %}
                                  {% if slot.total_unit.symbol %}{{ slot.total_unit.symbol }}{% else %}{{ slot.total_unit.abbrev }}{% endif %}
                                {% endif %}
                                {% if exchange.join_request.payment_pending_amount and not slot.is_share %} &nbsp; &nbsp;
                                  <b class="error">{% trans "Pending:" %} {% if exchange.join_request.is_flexprice %} ≈ {% endif %}{{ exchange.join_request.payment_pending_amount }}
                                  {{ exchange.join_request.show_payment_unit }}
                                  </b>
                                {% endif %}
                                {% if slot.is_share %} &nbsp; &nbsp;
                                  {% trans "Share:" %} <em><b>{{ slot.is_share.name }}</b></em>
                                {% endif %}
                                {% if request.user.is_superuser %} &nbsp; <em>(tt:{{ slot.id }} txs: {{ slot.xfers|length }} inco:{{ slot.is_income }})</em>{% endif %}
                            </p>
                            {% if agent and exchange and logger %}
                                {% if not slot.is_currency %}
                                  <div class="modal hide fade" id="addTransferModal{{ slot.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer{{ slot.id }}" aria-hidden="true">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h3 id="xfer{{ slot.id }}">{% trans "Log a new " %}{{ slot.name }}</h3>
                                    </div>
                                    <div class="modal-body">
                                        <form class="validateMe" id="xferForm{{ slot.id }}" enctype="multipart/form-data" action="{% url "add_transfer" exchange_id=exchange.id transfer_type_id=slot.id %}" method="POST" >
                                            {% csrf_token %}
                                            {% with slot.add_xfer_form as ax_form %}
                                            {% trans "Event date:" %}<br />{{ ax_form.event_date }}<br />
                                            {% if exchange.join_request %}
                                              {% if slot.is_share %}
                                                {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b> {{ ax_form.from_agent }}<br />
                                                {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b> {{ ax_form.to_agent }}<br />
                                              {% elif slot.is_currency %}
                                                {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                              {% endif %}
                                            {% else %}
                                                {% if not slot.give_agent_is_context %}{% trans "Transferred from:" %}<br />{{ ax_form.from_agent }}<br />{% endif %}
                                                {% if not slot.receive_agent_is_context %}{% trans "Transferred to:" %}<br />{{ ax_form.to_agent }}<br />{% endif %}
                                            {% endif %}
                                            {% if ax_form.ocp_resource_type %}
                                                {% trans "Type of Resource:" %} {% if request.user.is_superuser %}<i>{{ ax_form.ocp_resource_type.label }}</i>{% endif %}<br />{{ ax_form.ocp_resource_type }}
                                                <!-- <div class='add-new-type'>{{ add_type }}<a href='#' class='btn disabled btn-mini'>{% trans "New Resource Type" %}</a></div> -->
                                               <br />
                                            {% else %}
                                               <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />

                                                {% trans "Resource type transferred:" %}<br />{{ ax_form.resource_type }}<br />
                                            {% endif %}
                                            {% trans "Quantity transferred:" %}<br />{{ ax_form.quantity }}<br />
                                            {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                {% trans "Account from (if virtual account)" %}<br />{{ ax_form.from_resource }}<br />
                                                {% trans "Account to (if virtual account)" %}<br />{{ ax_form.resource }}<br />
                                            {% else %}
                                                {% trans "Resource transferred (no entry if not inventoried)" %}<br />{{ ax_form.resource }}<br />
                                            {% endif %}
                                            {% if not slot.is_currency %}
                                                {% trans "Value (total, not per unit)" %}:<br />{{ ax_form.value }}<br />
                                                {% trans "Unit of value" %}:<br />{{ ax_form.unit_of_value }}<br />
                                            {% endif %}
                                            {% if slot.is_contribution %}{% trans "Can be a rewarded in a value equation" %}:<br />{{ ax_form.is_contribution }}<br />{% endif %}
                                            {% if slot.is_to_distribute %}{% trans "Can be distributed in a value equation" %}:<br />{{ ax_form.is_to_distribute }}<br />{% endif %}
                                            {% if slot.is_currency %}{% trans "Event reference" %}:<br />{{ ax_form.event_reference }}<br />{% endif %}
                                            {% trans "Description" %}:<br />{{ ax_form.description }}<br />

                                            {% if slot.can_create_resource %}
                                                <br />
                                                <h4>{% trans "Incoming resource" %}:</h4>
                                                <p>{% trans "Add to an existing resource" %}:<br />{{ ax_form.resource }}
                                                <br />{% trans "OR" %} <b>{% trans "create a new resource" %}</b>:</p>
                                                {% trans "Identifier: (for example, lot number or serial number)" %}<br />{{ ax_form.identifier }}<br />
                                                URL:<br />{{ ax_form.url }}<br />
                                                {% trans "Photo URL" %}:<br />{{ ax_form.photo_url }}<br />
                                                {% trans "Current Resource Location" %}:<br />{{ ax_form.current_location }}<br />
                                                {% trans "Resource Notes" %}:<br />{{ ax_form.notes }}<br />
                                                {% trans "Resource Access Rules" %}:<br />{{ ax_form.access_rules }}<br />
                                                {{ slot.create_role_formset.management_form }}
                                                <table>
                                                    <tr>
                                                        <td>{% trans "Resource access role" %}</td>
                                                        <td>{% trans "Assignment" %}</td>
                                                        <td>{% trans "Is contact" %} &nbsp;</td>
                                                    </tr>
                                                    {% for form in slot.create_role_formset %}
                                                        {{ form.id }}
                                                        <tr class="role-row">
                                                            <td class="td-role">{{ form.role }}</td>
                                                            <td class="td-agent">{{ form.agent }}</td>
                                                            <td class="text-center">{{ form.is_contact }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </table>
                                            {% endif %}
                                            {% endwith %}
                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                            </div>
                                        </form>
                                    </div>
                                  </div>
                                {% endif %}
                                <div class="modal hide fade" id="addCommitModal{{ slot.id }}" tabindex="-1" role="dialog" aria-labelledby="commit" aria-hidden="true">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h3 id="commit">{% trans "Log a new Commitment:" %} {{ slot.name }}</h3>
                                    </div>
                                    <div class="modal-body">
                                        <form class="validateMe" id="commitForm" enctype="multipart/form-data" action="{% url "add_transfer_commitment_work" exchange_id=exchange.id transfer_type_id=slot.id %}" method="POST" >
                                            {% csrf_token %}
                                            {% with slot.add_commit_form as ac_form %}
                                            {% trans "Commitment date:" %}<br />{{ ac_form.commitment_date }}<br />
                                            {% trans "Due date:" %}<br />{{ ac_form.due_date }}<br />
                                            {% if exchange.join_request %}
                                              {% if slot.is_share %}
                                                {% trans "Transfer from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                {% trans "Transfer to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                              {% elif slot.is_currency %}
                                                {% trans "Transfer from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                {% trans "Transfer to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                              {% endif %}
                                            {% else %}
                                                {% if not slot.give_agent_is_context %}{% trans "Transfer from:" %}<br />{{ ac_form.from_agent }}<br />{% endif %}
                                                {% if not slot.receive_agent_is_context %}{% trans "Transfer to:" %}<br />{{ ac_form.to_agent }}<br />{% endif %}
                                            {% endif %}
                                            {% trans "Quantity:" %}<br />{{ ac_form.quantity }}<br />
                                            {% if ac_form.ocp_resource_type %}
                                               {% trans "Type of Resource:" %} {% if request.user.is_superuser %}<i>{{ ac_form.ocp_resource_type.label }}</i>{% endif %} <br />{{ ac_form.ocp_resource_type }}<br />
                                            {% else %}
                                               <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                {% trans "Resource type:" %}<br />{{ ac_form.resource_type }}<br />
                                            {% endif %}
                                            {% if not slot.is_currency %}
                                                {% trans "Value (total, not per unit):" %}<br />{{ ac_form.value }}<br />
                                                {% trans "Unit of value:" %}<br />{{ ac_form.unit_of_value }}<br />
                                            {% endif %}
                                            {% trans "Description:" %}<br />{{ ac_form.description }}<br />
                                            {% endwith %}
                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}

                            {% for xfer in slot.xfers %}
                                <div class="event">
                                    {% if xfer.commitments.all %}
                                      {% for comm in xfer.commitments.all_give %}
                                        <div class="comm"><span class="{{ comm.status }}">&#9679;</span>
                                        <span class="event-label">{% trans "Commitment" %}: </span>
                                        {{ comm|show_name:context_agent|safe }} {% if request.user.is_superuser %}&nbsp; <em>(tx:{{ xfer.id }} co:{{ comm.id }})</em>{% endif %}
                                        {% if logger or comm.created_by == request.user or comm.to_agent == agent or comm.to_agent in agent.managed_projects %}
                                          {% if logger and not exchange.join_request and not exchange.join_request.agent == agent %}
                                            {% if not comm.to_agent %}
                                               <a href="#agentModal{{ comm.id }}" class="btn btn-primary btn-mini" role="button" data-toggle="modal" alt="Create a new external agent (without a OCP user)">{% trans "New External Agent?" %}</a>
                                               <div class="modal hide fade" id="agentModal{{ comm.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                  <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="xfer-label">{% trans "Create an external economic agent" %}</h3>
                                                  </div>
                                                  <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "add_transfer_external_agent" commitment_id=xfer.commitments.first.id context_agent_id=context_agent.id %}" method="POST" >
                                                        {% csrf_token %}
                                                        {% with slot.add_ext_agent as ag_form %}
                                                          {{ ag_form|as_bootstrap }}
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                      <div class="modal-footer">
                                                        <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                        <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                      </div>
                                                    </form>
                                                  </div>
                                               </div>
                                            {% endif %}

                                            <a href="#cmitModal{{ comm.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                <i class="icon-edit"></i>
                                            </a>
                                            <div class="modal hide fade" id="cmitModal{{ comm.id }}" tabindex="-1" role="dialog" aria-labelledby="cmit-label" aria-hidden="true">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="cmit-label">{% trans "Change Transfer Commitment" %}</h3>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_commitments_work" transfer_id=xfer.id %}" method="POST" >
                                                        {% if comm.created_by == request.user %}<div style="float:right">
                                                        {% trans "...created by you" %}</div>{% endif %}
                                                        {% csrf_token %}
                                                        {% with xfer.change_commitments_context_form as cc_form %}
                                                        {% trans "Commitment date:" %}<br />{{ cc_form.commitment_date }}<br />
                                                        {% trans "Due date:" %}<br />{{ cc_form.due_date }}<br />
                                                        {% if exchange.join_request %}
                                                          {% if slot.is_share %}
                                                            {% trans "Transfer from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                            {% trans "Transfer to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                          {% elif slot.is_currency %}
                                                            {% trans "Transfer from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                            {% trans "Transfer to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                          {% endif %}
                                                        {% else %}
                                                            {% if not slot.give_agent_is_context %}{% trans "Transfer from:" %}<br />{{ cc_form.from_agent }}<br />{% endif %}
                                                            {% if not slot.receive_agent_is_context %}{% trans "Transfer to:" %}<br />{{ cc_form.to_agent }}<br />{% endif %}
                                                        {% endif %}
                                                        {% trans "Quantity:" %}<br />{{ cc_form.quantity }}<br />
                                                        {% if cc_form.ocp_resource_type %}
                                                          {% trans "Type of Resource:" %} {% if request.user.is_superuser %}<i>{{ cc_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                                          {{ cc_form.ocp_resource_type }}<br />
                                                        {% else %}
                                                          <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />

                                                          {% trans "Resource type:" %}<br />{{ cc_form.resource_type }}<br />
                                                        {% endif %}
                                                        {% if not slot.is_currency %}
                                                            {% trans "Value (total, not per unit):" %}<br />{{ cc_form.value }}<br />
                                                            {% trans "Unit of value:" %}<br />{{ cc_form.unit_of_value }}<br />
                                                        {% endif %}
                                                        {% trans "Description:" %}<br />{{ cc_form.description }}<br />
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if not comm.fulfillment_events.all and not exchange.join_request %}
                                                <form
                                                    style="display: inline;"
                                                    class="delete-form"
                                                    id="deleteForm{{ xfer.id }}"
                                                    action="{% url "delete_transfer_commitments" transfer_id=xfer.id commitment_id=comm.id %}"
                                                    method="POST" >
                                                    {% csrf_token %}
                                                    <input type="hidden" id="next" name="next" value="exchange-work" />
                                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                                </form>
                                                {% if comm.to_agent %}
                                                  <a href="#xferModal{{ comm.id }}" role="button" class="btn btn-primary btn-mini" data-toggle="modal" alt="Record transfer based on commitment">{% trans "Transfer This" %}</a>
                                                  <div class="modal hide fade" id="xferModal{{ comm.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                        <h3 id="xfer-label">{% trans "Make Transfer from Commitment" %}</h3>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form class="validateMe" enctype="multipart/form-data" action="{% url "transfer_from_commitment" transfer_id=xfer.id %}" method="POST" >
                                                            {% csrf_token %}
                                                            {% with xfer.commit_transfer_context_form as ct_form %}
                                                            {% trans "Event date:" %}<br />{{ ct_form.event_date }}<br />
                                                            {% if exchange.join_request %}
                                                              {% if slot.is_share %}
                                                                {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                                {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                              {% elif slot.is_currency %}
                                                                {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                                {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                              {% endif %}
                                                            {% else %}
                                                                {% if not slot.give_agent_is_context %}{% trans "Transferred from:" %}<br />{{ ct_form.from_agent }}<br />{% endif %}
                                                                {% if not slot.receive_agent_is_context %}{% trans "Transferred to:" %}<br />{{ ct_form.to_agent }}<br />{% endif %}
                                                            {% endif %}
                                                            {{ ct_form.quantity.label }}:<br />{{ ct_form.quantity }}<br />
                                                            {% if ct_form.ocp_resource_type %}
                                                              {% trans "Type of Resource transferred:" %} {% if request.user.is_superuser %}<i>{{ ct_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                                              {{ ct_form.ocp_resource_type }}<br />
                                                            {% else %}
                                                              <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                              {% trans "Resource type transferred:" %}<br />{{ ct_form.resource_type }}<br />
                                                            {% endif %}
                                                            {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                                {% trans "Account from (if virtual account)" %}<br />{{ ct_form.from_resource }}<br />
                                                                {% trans "Account to (if virtual account)" %}<br />{{ ct_form.resource }}<br />
                                                            {% else %}
                                                                {% trans "Resource transferred (no entry if not inventoried)" %}<br />{{ ct_form.resource }}<br />
                                                            {% endif %}
                                                            {% if not slot.is_currency %}
                                                                {% trans "Value (total, not per unit):" %}<br />{{ ct_form.value }}<br />
                                                                {% trans "Unit of value:" %}<br />{{ ct_form.unit_of_value }}<br />
                                                            {% endif %}
                                                            {% if slot.is_contribution %}{% trans "Can be a rewarded in a value equation:" %}<br />{{ ct_form.is_contribution }}<br />{% endif %}
                                                            {% if slot.is_to_distribute %}{% trans "Can be distributed in a value equation:" %}<br />{{ ct_form.is_to_distribute }}<br />{% endif %}
                                                            {% if slot.is_currency %}{% trans "Event reference:" %}<br />{{ ct_form.event_reference }}<br />{% endif %}
                                                            {% trans "Description:" %}<br />{{ ct_form.description }}<br />
                                                            {% if slot.can_create_resource %}
                                                                <br />
                                                                <h4>{% trans "Incoming resource:" %}</h4>
                                                                {% trans "Add to an existing resource:" %}<br />{{ ct_form.resource }}<br />
                                                                <br /><b>{% trans "OR create a new resource:" %}</b><br />
                                                                {% trans "Identifier: (for example, lot number or serial number)" %}<br />{{ ct_form.identifier }}<br />
                                                                URL:<br />{{ ct_form.url }}<br />
                                                                {% trans "Photo URL:" %}<br />{{ ct_form.photo_url }}<br />
                                                                {% trans "Current Resource Location:" %}<br />{{ ct_form.current_location }}<br />
                                                                {% trans "Resource Notes:" %}<br />{{ ct_form.notes }}<br />
                                                                {% trans "Resource Access Rules:" %}<br />{{ ct_form.access_rules }}<br />
                                                                {{ xfer.create_role_formset.management_form }}
                                                                {% trans "Resource access roles" %}<br />
                                                                {% for form in xfer.create_role_formset %}
                                                                    <tr>
                                                                        <td>{{ form.role }}</td>
                                                                        <td>{{ form.agent }}</td>
                                                                        <td>{{ form.is_contact }} Is contact</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            {% endif %}
                                                            {% endwith %}
                                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                                            <div class="modal-footer">
                                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                                <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                            </div>
                                                        </form>
                                                    </div>
                                                  </div>
                                                {% endif %}
                                            {% endif %}
                                          {% endif %}
                                        {% endif %}

                                        {% if xfer.commit_description %}
                                            <div class="notes"> {{ xfer.commit_description|urlize|linebreaks }} </div>
                                        {% endif %}
                                        {% if comm.fulfillment_events.all %}
                                          {% for evt in comm.fulfillment_events.all_give %}
                                            <div class="ce"><span class="complete">&#9679;</span> <span class="event-label">{% trans "Transfer" %}: </span>
                                                {{ evt|show_name:context_agent|safe }} {% if request.user.is_superuser %}&nbsp; <em>(tx:{{ xfer.id }} ev:{{ evt.id }})</em>{% endif %}
                                                {% if evt.faircoin_transaction %}&nbsp; <b><a href="{{ evt.faircoin_transaction.chain_link }}" target="_blank">FairTx</a></b>{% endif %}
                                                {% if evt.chain_transaction %}&nbsp; <b><a href="{{ evt.chain_transaction.chain_link }}" target="_blank">CryptoTx</a></b> {% if not evt.chain_transaction.tx_fee %}+ {{ evt.chain_transaction.update_data }}{% endif %} {% endif %}
                                                {% if logger or evt.created_by == request.user or evt.to_agent == agent or evt.to_agent in agent.managed_projects %}
                                                  {% if logger and not exchange.join_request and not exchange.join_request.agent == agent %}
                                                    <a href="#xferModal{{ evt.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                        <i class="icon-edit"></i>
                                                    </a>

                                                    <div class="modal hide fade" id="xferModal{{ evt.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                        <div class="modal-header">
                                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                            <h3 id="xfer-label">{% trans "Change Transfer" %}</h3>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_events_work" transfer_id=xfer.id context_agent_id=context_agent.id %}" method="POST" >
                                                                {% if evt.created_by == request.user %}<div style="float:right">
                                                                {% trans "...created by you" %}</div>{% endif %}

                                                                {% csrf_token %}
                                                                {% with xfer.change_events_context_form as ce_form %}
                                                                {% trans "Event date:" %}<br />{{ ce_form.event_date }}<br />
                                                                {% if exchange.join_request %}
                                                                  {% if slot.is_share %}
                                                                    {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                                    {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                                  {% elif slot.is_currency %}
                                                                    {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                                    {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                                  {% endif %}
                                                                {% else %}
                                                                    {% if not slot.give_agent_is_context %}{% trans "Transferred from:" %}<br />{{ ce_form.from_agent }}<br />{% endif %}
                                                                    {% if not slot.receive_agent_is_context %}{% trans "Transferred to:" %}<br />{{ ce_form.to_agent }}<br />{% endif %}
                                                                {% endif %}
                                                                {{ ce_form.quantity.label }}:<br />{{ ce_form.quantity }}<br />
                                                                {% if ce_form.ocp_resource_type %}
                                                                  {% trans "Type of Resource:" %} {% if request.user.is_superuser %}<i>{{ ce_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                                                  {{ ce_form.ocp_resource_type }}<br />
                                                                {% else %}
                                                                  <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                                  {% trans "Resource type transferred:" %}<br />{{ ce_form.resource_type }}<br />
                                                                {% endif %}
                                                                {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                                    {% trans "Account from (if virtual account)" %}<br />{{ ce_form.from_resource }}<br />
                                                                    {% trans "Account to (if virtual account)" %}<br />{{ ce_form.resource }}<br />
                                                                {% else %}
                                                                    {% trans "Resource transferred (only if inventoried):" %}<br />{{ ce_form.resource }}<br />
                                                                {% endif %}
                                                                {% if not slot.is_currency %}
                                                                    {% trans "Value (total, not per unit):" %}<br />{{ ce_form.value }}<br />
                                                                    {% trans "Unit of value:" %}<br />{{ ce_form.unit_of_value }}<br />
                                                                {% endif %}
                                                                {% if slot.is_contribution %}{% trans "Can be rewarded in a value equation:" %}<br />{{ ce_form.is_contribution }}<br />{% endif %}
                                                                {% if slot.is_to_distribute %}{% trans "Can be distributed in a value equation:" %}<br />{{ ce_form.is_to_distribute }}<br />{% endif %}
                                                                {% if slot.is_currency %}{% trans "Event reference:" %}<br />{{ ce_form.event_reference }}<br />{% endif %}
                                                                {% trans "Description:" %}<br />{{ ce_form.description }}<br />
                                                                {% endwith %}
                                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                                <div class="modal-footer">
                                                                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                                    <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    {% if not slot.is_currency and not exchange.join_request %}
                                                      <form
                                                        style="display: inline;"
                                                        class="delete-form"
                                                        id="deleteForm{{ event.id }}"
                                                        action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                        method="POST" >
                                                        {% csrf_token %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                                      </form>
                                                    {% endif %}
                                                  {% endif %}
                                                {% endif %}
                                                {% if evt.description %}
                                                    <div class="notes"> {{ evt.description|urlize|linebreaks }} </div>
                                                {% endif %}
                                            </div>
                                          {% endfor %}
                                        {% endif %}
                                        </div>
                                      {% endfor %}
                                    {% elif xfer.events.all %}
                                      {% for evt in xfer.events.all_give %}
                                        <div class="evt"><span class="complete">&#9679;</span>
                                        <span class="event-label">{% trans "Transfer" %}:</span>
                                        {{ evt|show_name:context_agent|safe }} {% if request.user.is_superuser %}&nbsp; <em>(tx:{{ xfer.id }} ev:{{ evt.id }})</em>{% endif %}
                                        {% if evt.faircoin_transaction %}&nbsp; <b><a href="{{ evt.faircoin_transaction.chain_link }}" target="_blank">FairTx</a></b>{% endif %}
                                        {% if evt.chain_transaction %}&nbsp; <b><a href="{{ evt.chain_transaction.chain_link }}" target="_blank">CryptoTx</a></b> {% if not evt.chain_transaction.tx_fee %}+ {{ evt.chain_transaction.update_data }}{% endif %} {% endif %}
                                        {% if logger or evt.created_by == request.user or evt.to_agent == agent or evt.to_agent in agent.managed_projects %}
                                          {% if logger and not exchange.join_request and not exchange.join_request.agent == agent %}
                                            <a href="#xferModal{{ evt.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                <i class="icon-edit"></i>
                                            </a>
                                            <div class="modal hide fade" id="xferModal{{ evt.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="xfer-label">{% trans "Change Transfer" %}</h3>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_events_work" transfer_id=xfer.id context_agent_id=context_agent.id %}" method="POST" >
                                                        {% if evt.created_by == request.user %}<div style="float:right">
                                                        {% trans "...created by you" %}</div>{% endif %}

                                                        {% csrf_token %}
                                                        {% with xfer.change_events_context_form as cev_form %}
                                                        {% trans "Event date:" %}<br />{{ cev_form.event_date }}<br />
                                                        {% if exchange.join_request %}
                                                          {% if slot.is_share %}
                                                            {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                            {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                          {% elif slot.is_currency %}
                                                            {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                            {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                          {% endif %}
                                                        {% else %}
                                                            {% if not slot.give_agent_is_context %}{% trans "Transferred from:" %}<br />{{ cev_form.from_agent }}<br />{% endif %}
                                                            {% if not slot.receive_agent_is_context %}{% trans "Transferred to:" %}<br />{{ cev_form.to_agent }}<br />{% endif %}
                                                        {% endif %}
                                                        {{ cev_form.quantity.label }}:<br />{{ cev_form.quantity }}<br />
                                                        {% if cev_form.ocp_resource_type %}
                                                          {% trans "Type of Resource transferred:" %} {% if request.user.is_superuser %}<i>{{ cev_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                                          {{ cev_form.ocp_resource_type }}<br />
                                                        {% else %}
                                                          <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                          {% trans "Resource type transferred:" %}<br />{{ cev_form.resource_type }}<br />
                                                        {% endif %}
                                                        {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                            {% trans "Account from (if virtual account)" %}<br />{{ cev_form.from_resource }}<br />
                                                            {% trans "Account to (if virtual account)" %}<br />{{ cev_form.resource }}<br />
                                                        {% else %}
                                                            {% trans "Resource transferred (only if inventoried):" %}<br />{{ cev_form.resource }}<br />
                                                        {% endif %}
                                                        {% if not slot.is_currency %}
                                                            {% trans "Value (total, not per unit):" %}<br />{{ cev_form.value }}<br />
                                                            {% trans "Unit of value:" %}<br />{{ cev_form.unit_of_value }}<br />
                                                        {% endif %}
                                                        {% if slot.is_contribution %}{% trans "Can be rewarded in a value equation:" %}<br />{{ cev_form.is_contribution }}<br />{% endif %}
                                                        {% if slot.is_to_distribute %}{% trans "Can be distributed in a value equation:" %}<br />{{ cev_form.is_to_distribute }}<br />{% endif %}
                                                        {% if slot.is_currency %}{% trans "Event reference:" %}<br />{{ cev_form.event_reference }}<br />{% endif %}
                                                        {% trans "Description:" %}<br />{{ cev_form.description }}<br />
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if not slot.is_currency and not exchange.join_request %}
                                              <form
                                                style="display: inline;"
                                                class="delete-form"
                                                id="deleteForm{{ xfer.id }}"
                                                action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                method="POST" >
                                                {% csrf_token %}
                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                              </form>
                                            {% endif %}
                                          {% endif %}
                                        {% endif %}
                                        {% if evt.description %}
                                            <div class="notes"> {{ evt.description|urlize|linebreaks }} </div>
                                        {% endif %}
                                        </div>
                                      {% endfor %}
                                    {% else %}
                                        <em class="">{% trans "This transfer has not any event or commitment yet..." %}</em>
                                        {% if not forloop.first and request.user.is_superuser %}
                                            <em>(id:{{ xfer.id }})</em>
                                            <form
                                                  style="display: inline;"
                                                  class="delete-form"
                                                  id="deleteForm{{ xfer.id }}"
                                                  action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                  method="POST" >
                                                {% csrf_token %}
                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endfor %}

                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}
            {% if True or exchange.can_have_reciprocal_transfers or tt and tt.is_income %}
            <div class="trt infobox">
                <h3 CLASS="trtheading">{% trans "Incoming Transfers" %}
                {% if logger %}<span class="info"> <a href="#" id="rxfer-info" data-toggle="popover" data-trigger='hover' title="Reciprocal Transfers" data-placement="left"
                    data-content="Log the planned and actual reciprocal transfers for this exchange.  The types of reciprocal transfers are determined by the type of exchange,
                    as defined by your previous selections.  They are in return for the primary transfers above.">
                    <img src="{% static 'img/information-icon.png' %}" /></a>
                </span>
                {% endif %}
                </h3>
                {% for slot in slots %}
                    {% if slot.is_income %}
                        <div class="log-section infobox2">
                            <h3>
                                {{ slot|show_name:context_agent|safe }}
                                {% if agent and exchange and logger %}
                                    <a href="#addCommitModal{{ slot.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Log a new commitment or plan for a transfer" >
                                        {% trans "New Commitment" %}
                                    </a>
                                    {% if not slot.is_currency %}
                                      <a href="#addTransferModal{{ slot.id }}" role="button" class="btn btn-primary btn-mini" data-toggle="modal" title="Log a new transfer without a commitment or plan" >
                                        {% trans "New Transfer" %}
                                      </a>
                                    {% endif %}
                                {% endif %}
                            </h3>
                            <p style="total">{% trans "Status" %}: <span class="{{ slot.status }}">{{ slot.status|title }}</span> &nbsp; &nbsp;
                                {% trans "Total:" %} {{ slot.total }}
                                {% if exchange.join_request and slot.is_currency %}{{ exchange.join_request.show_payment_unit }}
                                {% elif slot.total %}
                                  {% if slot.total_unit.symbol %}{{ slot.total_unit.symbol }}{% else %}{{ slot.total_unit.abbrev }}{% endif %}
                                {% endif %}
                                {% if exchange.join_request.payment_pending_amount and not slot.is_share %} &nbsp; &nbsp;
                                  <b class="error">{% trans "Pending:" %} {% if exchange.join_request.is_flexprice %} ≈ {% endif %}{{ exchange.join_request.payment_pending_amount }}
                                  {{ exchange.join_request.show_payment_unit }}
                                  </b>
                                {% endif %}
                                {% if slot.is_share %} &nbsp; &nbsp;
                                  {% trans "Share:" %} <em><b>{{ slot.is_share.name }}</b></em>
                                {% endif %}
                                {% if request.user.is_superuser %} &nbsp; <em>(tt:{{ slot.id }} txs: {{ slot.xfers|length }} inco:{{ slot.is_income }})</em>{% endif %}
                            </p>
                            {% if agent and exchange and logger %}
                                {% if not slot.is_currency %}
                                  <div class="modal hide fade" id="addTransferModal{{ slot.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer{{ slot.id }}" aria-hidden="true">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h3 id="xfer{{ slot.id }}">{% trans "Log a new:" %} {{ slot.name }}</h3>
                                    </div>
                                    <div class="modal-body">
                                        <form class="validateMe" id="xferForm{{ slot.id }}" enctype="multipart/form-data" action="{% url "add_transfer" exchange_id=exchange.id transfer_type_id=slot.id %}" method="POST" >
                                            {% csrf_token %}
                                            {% with slot.add_xfer_form as ax_form %}
                                            {% trans "Event date:" %}<br />{{ ax_form.event_date }}<br />
                                            {% if exchange.join_request %}
                                              {% if slot.is_share %}
                                                {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                              {% elif slot.is_currency %}
                                                {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                              {% endif %}
                                            {% else %}
                                                {% if not slot.give_agent_is_context %}{% trans "Transferred from:" %}<br />{{ ax_form.from_agent }}<br />{% endif %}
                                                {% if not slot.receive_agent_is_context %}{% trans "Transferred to:" %}<br />{{ ax_form.to_agent }}<br />{% endif %}
                                            {% endif %}
                                            {% trans "Quantity transferred:" %}<br />{{ ax_form.quantity }}<br />
                                            {% if ax_form.ocp_resource_type %}
                                              {% trans "Type of Resource:" %} {% if request.user.is_superuser %}<i>{{ ax_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                              {{ ax_form.ocp_resource_type }}
                                              <!-- <div class='add-new-type'>{{ add_type }}<a href='#' class='btn disabled btn-mini'>{% trans "New Resource Type" %}</a></div> -->
                                              <br />
                                            {% else %}
                                              <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                              {% trans "Resource type transferred:" %}<br />{{ ax_form.resource_type }}<br />
                                            {% endif %}
                                            {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                {% trans "Account from (if virtual account)" %}<br />{{ ax_form.from_resource }}<br />
                                                {% trans "Account to (if virtual account)" %}<br />{{ ax_form.resource }}<br />
                                            {% else %}
                                                {% trans "Resource transferred (no entry if not inventoried)" %}<br />{{ ax_form.resource }}<br />
                                            {% endif %}
                                            {% if not slot.is_currency %}
                                                {% trans "Value (total, not per unit):" %}<br />{{ ax_form.value }}<br />
                                                {% trans "Unit of value:" %}<br />{{ ax_form.unit_of_value }}<br />
                                            {% endif %}
                                            {% if slot.is_contribution %}{% trans "Can be a rewarded in a value equation:" %}<br />{{ ax_form.is_contribution }}<br />{% endif %}
                                            {% if slot.is_to_distribute %}{% trans "Can be distributed in a value equation:" %}<br />{{ ax_form.is_to_distribute }}<br />{% endif %}
                                            {% if slot.is_currency %}{% trans "Event reference:" %}<br />{{ ax_form.event_reference }}<br />{% endif %}
                                            {% trans "Description:" %}<br />{{ ax_form.description }}<br />

                                            {% if slot.can_create_resource %}
                                                <br />
                                                <h4>{% trans "Incoming resource:" %}</h4>
                                               {% trans "Add to an existing resource:" %}<br />{{ ax_form.resource }}<br />
                                                <br /><b>{% trans "OR create a new resource:" %}</b><br />
                                                {% trans "Identifier: (for example, lot number or serial number)" %}<br />{{ ax_form.identifier }}<br />
                                                URL:<br />{{ ax_form.url }}<br />
                                                {% trans "Photo URL:" %}<br />{{ ax_form.photo_url }}<br />
                                                {% trans "Current Resource Location:" %}<br />{{ ax_form.current_location }}<br />
                                                {% trans "Resource Notes:" %}<br />{{ ax_form.notes }}<br />
                                                {% trans "Resource Access Rules:" %}<br />{{ ax_form.access_rules }}<br />
                                                {{ slot.create_role_formset.management_form }}
                                                <table>
                                                    <tr>
                                                        <td>{% trans "Resource access role" %}</td>
                                                        <td>{% trans "Assignment" %}</td>
                                                        <td>{% trans "Is contact" %} &nbsp;</td>
                                                    </tr>
                                                    {% for form in slot.create_role_formset %}
                                                        {{ form.id }}
                                                        <tr class="role-row">
                                                            <td class="td-role">{{ form.role }}</td>
                                                            <td class="td-agent">{{ form.agent }}</td>
                                                            <td class="text-center">{{ form.is_contact }}</td>
                                                        </tr>
                                                    {% endfor %}
                                                </table>
                                            {% endif %}
                                            {% endwith %}
                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                            </div>
                                        </form>
                                    </div>
                                  </div>
                                {% endif %}
                                <div class="modal hide fade" id="addCommitModal{{ slot.id }}" tabindex="-1" role="dialog" aria-labelledby="commit" aria-hidden="true">
                                    <div class="modal-header">
                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                        <h3 id="commit">{% trans "Log a new Commitment:" %} {{ slot.name }}</h3>
                                    </div>
                                    <div class="modal-body">
                                        <form class="validateMe" id="commitForm" enctype="multipart/form-data" action="{% url "add_transfer_commitment_work" exchange_id=exchange.id transfer_type_id=slot.id %}" method="POST" >
                                            {% csrf_token %}
                                            {% with slot.add_commit_form as ac_form %}
                                            {% trans "Commitment date:" %}<br />{{ ac_form.commitment_date }}<br />
                                            {% trans "Due date:" %}<br />{{ ac_form.due_date }}<br />
                                            {% if exchange.join_request %}
                                              {% if slot.is_share %}
                                                {% trans "Transfer from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                {% trans "Transfer to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                              {% elif slot.is_currency %}
                                                {% trans "Transfer from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                {% trans "Transfer to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                              {% endif %}
                                            {% else %}
                                                {% if not slot.give_agent_is_context %}{% trans "Transfer from:" %}<br />{{ ac_form.from_agent }}<br />{% endif %}
                                                {% if not slot.receive_agent_is_context %}{% trans "Transfer to:" %}<br />{{ ac_form.to_agent }}<br />{% endif %}
                                            {% endif %}
                                            {% trans "Quantity:" %}<br />{{ ac_form.quantity }}<br />
                                            {% if ac_form.ocp_resource_type %}
                                              {% trans "Type of Resource:" %} {% if request.user.is_superuser %}<i>{{ ac_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                              {{ ac_form.ocp_resource_type }}<br />
                                            {% else %}
                                              <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                              {% trans "Resource type:" %}<br />{{ ac_form.resource_type }}<br />
                                            {% endif %}
                                            {% if not slot.is_currency %}
                                                {% trans "Value (total, not per unit):" %}<br />{{ ac_form.value }}<br />
                                                {% trans "Unit of value:" %}<br />{{ ac_form.unit_of_value }}<br />
                                            {% endif %}
                                            {% trans "Description:" %}<br />{{ ac_form.description }}<br />
                                            {% endwith %}
                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                            <div class="modal-footer">
                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            {% endif %}

                            {% for xfer in slot.xfers %}
                                <div class="event">
                                    {% if xfer.commitments.all %}
                                      {% for comm in xfer.commitments.all_give %}
                                        <div class="comm"><span class="{{ comm.status }}">&#9679;</span>
                                        <span class="event-label">{% trans "Commitment" %}: </span>
                                        {{ comm|show_name:context_agent|safe }} {% if request.user.is_superuser %}&nbsp; <em>(tx:{{ xfer.id }} co:{{ comm.id }})</em>{% endif %}
                                        {% if logger or comm.created_by == request.user or comm.from_agent == request.user.agent.agent or comm.from_agent in request.user.agent.agent.managed_projects %}
                                          {% if logger and not exchange.join_request and not exchange.join_request.agent == agent %}
                                            {% if not comm.from_agent %}
                                               <a href="#agentModal{{ comm.id }}" class="btn btn-primary btn-mini" role="button" data-toggle="modal" alt="Create a new external agent (without a OCP user)">{% trans "New External Agent?" %}</a>
                                               <div class="modal hide fade" id="agentModal{{ comm.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                  <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="xfer-label">{% trans "Create an external economic agent" %}</h3>
                                                  </div>
                                                  <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "add_transfer_external_agent" commitment_id=xfer.commitments.first.id context_agent_id=context_agent.id %}" method="POST" >
                                                        {% csrf_token %}
                                                        {% with slot.add_ext_agent as ag_form %}
                                                          {{ ag_form|as_bootstrap }}
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                      <div class="modal-footer">
                                                        <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                        <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                      </div>
                                                    </form>
                                                  </div>
                                               </div>
                                            {% endif %}
                                            <a href="#cmitModal{{ comm.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                <i class="icon-edit"></i>
                                            </a>
                                            <div class="modal hide fade" id="cmitModal{{ comm.id }}" tabindex="-1" role="dialog" aria-labelledby="cmit-label" aria-hidden="true">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="cmit-label">{% trans "Change Transfer Commitment" %}</h3>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_commitments_work" transfer_id=xfer.id %}" method="POST" >
                                                        {% if xfer.commitments.first.created_by == request.user %}<div style="float:right">
                                                        {% trans "...created by you" %}</div>{% endif %}

                                                        {% csrf_token %}
                                                        {% with xfer.change_commitments_context_form as cc_form %}
                                                        {% trans "Commitment date:" %}<br />{{ cc_form.commitment_date }}<br />
                                                        {% trans "Due date:" %}<br />{{ cc_form.due_date }}<br />
                                                        {% if exchange.join_request %}
                                                          {% if slot.is_share %}
                                                            {% trans "Transfer from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                            {% trans "Transfer to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                          {% elif slot.is_currency %}
                                                            {% trans "Transfer from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                            {% trans "Transfer to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                          {% endif %}
                                                        {% else %}
                                                            {% if not slot.give_agent_is_context %}{% trans "Transfer from:" %}<br />{{ cc_form.from_agent }}<br />{% endif %}
                                                            {% if not slot.receive_agent_is_context %}{% trans "Transfer to:" %}<br />{{ cc_form.to_agent }}<br />{% endif %}
                                                        {% endif %}
                                                        {% trans "Quantity:" %}<br />{{ cc_form.quantity }}<br />
                                                        {% if cc_form.ocp_resource_type %}
                                                          {% trans "Type of Resource:" %} {% if request.user.is_superuser %}<i>{{ cc_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                                          {{ cc_form.ocp_resource_type }}<br />
                                                        {% else %}
                                                          <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />

                                                          {% trans "Resource type:" %}<br />{{ cc_form.resource_type }}<br />
                                                        {% endif %}
                                                        {% if not slot.is_currency %}
                                                            {% trans "Value (total, not per unit):" %}<br />{{ cc_form.value }}<br />
                                                            {% trans "Unit of value:" %}<br />{{ cc_form.unit_of_value }}<br />
                                                        {% endif %}
                                                        {% trans "Description:" %}<br />{{ cc_form.description }}<br />
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if not comm.fulfillment_events.all %}
                                                <form
                                                    style="display: inline;"
                                                    class="delete-form"
                                                    id="deleteForm{{ comm.id }}"
                                                    action="{% url "delete_transfer_commitments" transfer_id=xfer.id commitment_id=comm.id %}"
                                                    method="POST" >
                                                    {% csrf_token %}
                                                    <input type="hidden" id="next" name="next" value="exchange-work" />
                                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete commitment" >X</button>
                                                </form>
                                                {% if comm.from_agent %}
                                                  <a href="#xferModal{{ comm.id }}" role="button" class="btn btn-primary btn-mini" data-toggle="modal" alt="Record transfer based on commitment">{% trans "Transfer This" %}</a>
                                                  <div class="modal hide fade" id="xferModal{{ comm.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                    <div class="modal-header">
                                                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                        <h3 id="xfer-label">{% trans "Make Transfer from Commitment" %}</h3>
                                                    </div>
                                                    <div class="modal-body">
                                                        <form class="validateMe" enctype="multipart/form-data" action="{% url "transfer_from_commitment" transfer_id=xfer.id %}" method="POST" >
                                                            {% csrf_token %}
                                                            {% with xfer.commit_transfer_context_form as ct_form %}
                                                            {% trans "Event date:" %}<br />{{ ct_form.event_date }}<br />
                                                            {% if exchange.join_request %}
                                                              {% if slot.is_share %}
                                                                {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                                {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                              {% elif slot.is_currency %}
                                                                {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                                {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                              {% endif %}
                                                            {% else %}
                                                                {% if not slot.give_agent_is_context %}{% trans "Transferred from:" %}<br />{{ ct_form.from_agent }}<br />{% endif %}
                                                                {% if not slot.receive_agent_is_context %}{% trans "Transferred to:" %}<br />{{ ct_form.to_agent }}<br />{% endif %}
                                                            {% endif %}
                                                            {% trans "Quantity transferred:" %}<br />{{ ct_form.quantity }}<br />
                                                            {% if ct_form.ocp_resource_type %}
                                                              {% trans "Type of Resource transferred:" %} {% if request.user.is_superuser %}<i>{{ ct_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                                              {{ ct_form.ocp_resource_type }}<br />
                                                            {% else %}
                                                              <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                              {% trans "Resource type transferred:" %}<br />{{ ct_form.resource_type }}<br />
                                                            {% endif %}
                                                            {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                                {% trans "Account from (if virtual account)" %}<br />{{ ct_form.from_resource }}<br />
                                                                {% trans "Account to (if virtual account)" %}<br />{{ ct_form.resource }}<br />
                                                            {% else %}
                                                                {% trans "Resource transferred (no entry if not inventoried)" %}<br />{{ ct_form.resource }}<br />
                                                            {% endif %}
                                                            {% if not slot.is_currency %}
                                                                {% trans "Value (total, not per unit):" %}<br />{{ ct_form.value }}<br />
                                                                {% trans "Unit of value:" %}<br />{{ ct_form.unit_of_value }}<br />
                                                            {% endif %}
                                                            {% if slot.is_contribution %}{% trans "Can be a rewarded in a value equation:" %}<br />{{ ct_form.is_contribution }}<br />{% endif %}
                                                            {% if slot.is_to_distribute %}{% trans "Can be distributed in a value equation:" %}<br />{{ ct_form.is_to_distribute }}<br />{% endif %}
                                                            {% if slot.is_currency %}{% trans "Event reference:" %}<br />{{ ct_form.event_reference }}<br />{% endif %}
                                                            {% trans "Description:" %}<br />{{ ct_form.description }}<br />
                                                            {% if slot.can_create_resource %}
                                                                <br />
                                                                <h4>{% trans "Incoming resource:" %}</h4>
                                                                {% trans "Add to an existing resource:" %}<br />{{ ct_form.resource }}<br />
                                                                <br /><b>{% trans "OR create a new resource:" %}</b><br />
                                                                {% trans "Identifier: (for example, lot number or serial number)" %}<br />{{ ct_form.identifier }}<br />
                                                                URL:<br />{{ ct_form.url }}<br />
                                                                {% trans "Photo URL:" %}<br />{{ ct_form.photo_url }}<br />
                                                                {% trans "Current Resource Location:" %}<br />{{ ct_form.current_location }}<br />
                                                                {% trans "Resource Notes:" %}<br />{{ ct_form.notes }}<br />
                                                                {% trans "Resource Access Rules:" %}<br />{{ ct_form.access_rules }}<br />
                                                                {{ xfer.create_role_formset.management_form }}
                                                                {% trans "Resource access roles" %}<br />
                                                                {% for form in xfer.create_role_formset %}
                                                                    <tr>
                                                                        <td>{{ form.role }}</td>
                                                                        <td>{{ form.agent }}</td>
                                                                        <td>{{ form.is_contact }} Is contact</td>
                                                                    </tr>
                                                                {% endfor %}
                                                            {% endif %}
                                                            {% endwith %}
                                                            <input type="hidden" id="next" name="next" value="exchange-work" />
                                                            <div class="modal-footer">
                                                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                                <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                            </div>
                                                        </form>
                                                    </div>
                                                  </div>
                                                {% endif %}
                                            {% endif %}
                                          {% endif %}
                                        {% endif %}
                                        {% if xfer.commit_description %}
                                            <div class="notes"> {{ xfer.commit_description|urlize|linebreaks }} </div>
                                        {% endif %}
                                        {% if comm.fulfillment_events.all %}
                                          {% for evt in comm.fulfillment_events.all_give %}
                                            <div class="ce"><span class="complete">&#9679;</span> <span class="event-label">{% trans "Transfer" %}: </span>
                                                {{ evt|show_name:context_agent|safe }} {% if request.user.is_superuser %}&nbsp; <em>(tx:{{ xfer.id }} ev:{{ evt.id }})</em>{% endif %}
                                                {% if evt.faircoin_transaction %}&nbsp; <b><a href="{{ evt.faircoin_transaction.chain_link }}" target="_blank">FairTx</a></b>{% endif %}
                                                {% if evt.chain_transaction %}&nbsp; <b><a href="{{ evt.chain_transaction.chain_link }}" target="_blank">CryptoTx</a></b> {% if not evt.chain_transaction.tx_fee %}+ {{ evt.chain_transaction.update_data }}{% endif %} {% endif %}
                                                {% if logger or evt.created_by == request.user or evt.from_agent == agent or evt.from_agent in agent.managed_projects %}
                                                  {% if logger and not exchange.join_request %}
                                                    <a href="#xferModal{{ evt.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                        <i class="icon-edit"></i>
                                                    </a>

                                                    <div class="modal hide fade" id="xferModal{{ evt.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                        <div class="modal-header">
                                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                            <h3 id="xfer-label">{% trans "Change Transfer" %}</h3>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_events_work" transfer_id=xfer.id context_agent_id=context_agent.id %}" method="POST" >
                                                                {% if xfer.events.first.created_by == request.user %}<div style="float:right">
                                                                {% trans "...created by you" %}</div>{% endif %}

                                                                {% csrf_token %}
                                                                {% with xfer.change_events_context_form as ce_form %}
                                                                {% trans "Event date:" %}<br />{{ ce_form.event_date }}<br />
                                                                {% if exchange.join_request %}
                                                                  {% if slot.is_share %}
                                                                    {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                                    {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                                  {% elif slot.is_currency %}
                                                                    {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                                    {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                                  {% endif %}
                                                                {% else %}
                                                                    {% if not slot.give_agent_is_context %}{% trans "Transferred from:" %}<br />{{ ce_form.from_agent }}<br />{% endif %}
                                                                    {% if not slot.receive_agent_is_context %}{% trans "Transferred to:" %}<br />{{ ce_form.to_agent }}<br />{% endif %}
                                                                {% endif %}
                                                                {% trans "Quantity transferred:" %}<br />{{ ce_form.quantity }}<br />
                                                                {% if ce_form.ocp_resource_type %}
                                                                  {% trans "Type of Resource transferred:" %} {% if request.user.is_superuser %}<i>{{ ce_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                                                  {{ ce_form.ocp_resource_type }}<br />
                                                                {% else %}
                                                                  <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                                  {% trans "Resource type transferred:" %}<br />{{ ce_form.resource_type }}<br />
                                                                {% endif %}
                                                                {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                                    {% trans "Account from (if virtual account)" %}<br />{{ ce_form.from_resource }}<br />
                                                                    {% trans "Account to (if virtual account)" %}<br />{{ ce_form.resource }}<br />
                                                                {% else %}
                                                                    {% trans "Resource transferred (only if inventoried):" %}<br />{{ ce_form.resource }}<br />
                                                                {% endif %}
                                                                {% if not slot.is_currency %}
                                                                    {% trans "Value (total, not per unit):" %}<br />{{ ce_form.value }}<br />
                                                                    {% trans "Unit of value:" %}<br />{{ ce_form.unit_of_value }}<br />
                                                                {% endif %}
                                                                {% if slot.is_contribution %}{% trans "Can be rewarded in a value equation:" %}<br />{{ ce_form.is_contribution }}<br />{% endif %}
                                                                {% if slot.is_to_distribute %}{% trans "Can be distributed in a value equation:" %}<br />{{ ce_form.is_to_distribute }}<br />{% endif %}
                                                                {% if slot.is_currency %}{% trans "Event reference:" %}<br />{{ ce_form.event_reference }}<br />{% endif %}
                                                                {% trans "Description:" %}<br />{{ ce_form.description }}<br />
                                                                {% endwith %}
                                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                                <div class="modal-footer">
                                                                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                                    <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                    {% if not slot.is_currency and not exchange.join_request %}
                                                      <form
                                                        style="display: inline;"
                                                        class="delete-form"
                                                        id="deleteForm{{ event.id }}"
                                                        action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                        method="POST" >
                                                        {% csrf_token %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                                      </form>
                                                    {% endif %}
                                                  {% endif %}
                                                {% endif %}
                                                {% if event.description %}
                                                    <div class="notes"> {{ event.description|urlize|linebreaks }} </div>
                                                {% endif %}
                                            </div>
                                          {% endfor %}
                                        {% endif %}
                                        </div>
                                      {% endfor %}
                                    {% elif xfer.events.all %}
                                      {% for evt in xfer.events.all_give %}
                                        <div class="evt"><span class="complete">&#9679;</span>
                                        <span class="event-label">{% trans "Transfer" %}: </span>
                                        {{ evt|show_name:context_agent|safe }} {% if request.user.is_superuser %}<em>(tx:{{ xfer.id }} ev:{{ evt.id }} co:{{ evt.commitment.id }})</em>{% endif %}
                                        {% if evt.faircoin_transaction %}&nbsp; <b><a href="{{ evt.faircoin_transaction.chain_link }}" target="_blank">FairTx</a></b>{% endif %}
                                        {% if evt.chain_transaction %}&nbsp; <b><a href="{{ evt.chain_transaction.chain_link }}" target="_blank">CryptoTx</a></b> {% if not evt.chain_transaction.tx_fee %}+ {{ evt.chain_transaction.update_data }}{% endif %} {% endif %}
                                        {% if logger or evt.created_by == request.user or evt.from_agent == agent or evt.from_agent in agent.managed_projects  %}
                                          {% if logger and not exchange.join_request and not exchange.join_request.agent == agent %}
                                            <a href="#xferModal{{ evt.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                                <i class="icon-edit"></i>
                                            </a>
                                            <div class="modal hide fade" id="xferModal{{ evt.id }}" tabindex="-1" role="dialog" aria-labelledby="xfer-label" aria-hidden="true">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                                    <h3 id="xfer-label">{% trans "Change Transfer" %}</h3>
                                                </div>
                                                <div class="modal-body">
                                                    <form class="validateMe" enctype="multipart/form-data" action="{% url "change_transfer_events_work" transfer_id=xfer.id context_agent_id=context_agent.id %}" method="POST" >
                                                        {% if evt.created_by == request.user %}<div style="float:right">
                                                        {% trans "...created by you" %}</div>{% endif %}

                                                        {% csrf_token %}
                                                        {% with xfer.change_events_context_form as cev_form %}
                                                        {% trans "Event date:" %}<br />{{ cev_form.event_date }}<br />
                                                        {% if exchange.join_request %}
                                                          {% if slot.is_share %}
                                                            {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                            {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                          {% elif slot.is_currency %}
                                                            {% trans "Transferred from:" %}<br /><b>{{ exchange.join_request.agent.name }}</b><br />
                                                            {% trans "Transferred to:" %}<br /><b>{{ exchange.join_request.project.agent.name }}</b><br />
                                                          {% endif %}
                                                        {% else %}
                                                            {% if not slot.give_agent_is_context %}{% trans "Transferred from:" %}<br />{{ cev_form.from_agent }}<br />{% endif %}
                                                            {% if not slot.receive_agent_is_context %}{% trans "Transferred to:" %}<br />{{ cev_form.to_agent }}<br />{% endif %}
                                                        {% endif %}
                                                        {% trans "Quantity transferred:" %}<br />{{ cev_form.quantity }}<br />
                                                        {% if cev_form.ocp_resource_type %}
                                                          {% trans "Type of Resource transferred:" %} {% if request.user.is_superuser %}<i>{{ cev_form.ocp_resource_type.label }}</i>{% endif %}<br />
                                                          {{ cev_form.ocp_resource_type }}<br />
                                                        {% else %}
                                                          <span class="error">{% trans "Can't retrieve General types, try choosing a resource type below:" %}</span><br />
                                                          {% trans "Resource type transferred:" %}<br />{{ cev_form.resource_type }}<br />
                                                        {% endif %}
                                                        {% if slot.is_currency and xfer.transfer_type.exchange_type.use_case.identifier == "intrnl_xfer" %}
                                                            {% trans "Account from (if virtual account)" %}<br />{{ cev_form.from_resource }}<br />
                                                            {% trans "Account to (if virtual account)" %}<br />{{ cev_form.resource }}<br />
                                                        {% else %}
                                                            {% trans "Resource transferred (only if inventoried):" %}<br />{{ cev_form.resource }}<br />
                                                        {% endif %}
                                                        {% if not slot.is_currency %}
                                                            {% trans "Value (total, not per unit):" %}<br />{{ cev_form.value }}<br />
                                                            {% trans "Unit of value:" %}<br />{{ cev_form.unit_of_value }}<br />
                                                        {% endif %}
                                                        {% if slot.is_contribution %}{% trans "Can be rewarded in a value equation:" %}<br />{{ cev_form.is_contribution }}<br />{% endif %}
                                                        {% if slot.is_to_distribute %}{% trans "Can be distributed in a value equation:" %}<br />{{ cev_form.is_to_distribute }}<br />{% endif %}
                                                        {% if slot.is_currency %}{% trans "Event reference:" %}<br />{{ cev_form.event_reference }}<br />{% endif %}
                                                        {% trans "Description:" %}<br />{{ cev_form.description }}<br />
                                                        {% endwith %}
                                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                                        <div class="modal-footer">
                                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            {% if not slot.is_currency and not exchange.join_request %}
                                              <form
                                                style="display: inline;"
                                                class="delete-form"
                                                id="deleteForm{{ xfer.id }}"
                                                action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                method="POST" >
                                                {% csrf_token %}
                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                              </form>
                                            {% endif %}
                                          {% endif %}
                                        {% endif %}
                                        {% if xfer.event_description %}
                                            <div class="notes"> {{ xfer.event_description|urlize|linebreaks }} </div>
                                        {% endif %}
                                        </div>
                                      {% endfor %}
                                    {% else %}
                                        <em class="">{% trans "This transfer has not any event or commitment yet..." %}</em>
                                        {% if not forloop.first and request.user.is_superuser %}
                                            <em>(id:{{ xfer.id }})</em>
                                            <form
                                                  style="display: inline;"
                                                  class="delete-form"
                                                  id="deleteForm{{ xfer.id }}"
                                                  action="{% url "delete_transfer_events" transfer_id=xfer.id %}"
                                                  method="POST" >
                                                {% csrf_token %}
                                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete transfer" >X</button>
                                            </form>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% endfor %}

                        </div>
                    {% endif %}

                {% endfor %}
            </div>
            {% endif %}

            {% if not exchange.join_request.agent == agent and exchange.join_request.project.agent.need_tasks %}
            <div class="log-section infobox2">
                <h3 style="margin-bottom: 4px;" >
                    {% trans "Work" %}
                    {% if logger and exchange %}
                        <a href="#addWorkModal" role="button" class="btn btn-info btn-mini" data-toggle="modal" title="Add work done for this exchange.">
                            {% trans "Log a work event" %}
                        </a>
                    {% endif %}
                    <span class="info"> <a href="#" id="work-info" data-toggle="popover" data-trigger='hover' title="Work Events"
                        data-content="Enter the time you spent on this exchange. This might be preparing paperwork,
                        communicating, traveling, even logging the exchange." data-placement="left">
                        <img src="{% static 'img/information-icon.png' %}" /></a>
                    </span>
                </h3>
                {% if logger and exchange %}
                    <div class="modal hide fade" id="addWorkModal" tabindex="-1" role="dialog" aria-labelledby="work-label" aria-hidden="true">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h3 id="work-label">{% trans "Add Work Done for This Exchange" %}</h3>
                        </div>
                        <div class="modal-body">
                            <form class="validateMe" id="workForm" enctype="multipart/form-data" action="{% url "add_work_for_exchange" exchange_id=exchange.id %}" method="POST" >
                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                {% csrf_token %}
                                <label>{{ add_work_form.event_date.label }}:</label> {{ add_work_form.event_date }}
                                {% if add_work_form.event_date.help_text %}<br/><span class="helptext">{{ add_work_form.event_date.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.ocp_skill_type.label }}:</label> {{ add_work_form.ocp_skill_type }}
                                {% if add_work_form.ocp_skill_type.help_text %}<br/><span class="helptext">{{ add_work_form.ocp_skill_type.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.from_agent.label }}:</label> {{ add_work_form.from_agent }}
                                {% if add_work_form.from_agent.help_text %}<br/><span class="helptext">{{ add_work_form.from_agent.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.quantity.label }}:</label> {{ add_work_form.quantity }}
                                {% if add_work_form.quantity.help_text %}<br/><span class="helptext">{{ add_work_form.quantity.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.is_contribution.label }}:</label> {{ add_work_form.is_contribution }}
                                {% if add_work_form.is_contribution.help_text %}<br/><span class="helptext">{{ add_work_form.is_contribution.help_text }}</span>{% endif %}
                                <label>{{ add_work_form.description.label }}:</label> {{ add_work_form.description }}
                                {% if add_work_form.description.help_text %}<br/><span class="helptext">{{ add_work_form.description.help_text }}</span>{% endif %}
                                <div class="modal-footer">
                                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                    <input type="submit" class="btn btn-primary" name="submit" value="{% trans 'Save' %}" />
                                </div>
                            </form>
                        </div>
                    </div>
                {% endif %}

                {% for event in work_events %}
                    <div class="event" >
                        <span ><span class="event-label">{% trans "Work event" %}: </span><b> {{ event.resource_type.name }}</b> {{ event.quantity }} {{ event.unit_of_quantity }} {{ event.event_date }} <span class="taken">{% trans "Done by" %} {{ event.from_agent.nick }}</span></span>
                        {% if agent == event.from_agent or logger or event.created_by == request.user %}
                          {% if logger %}
                            <a href="#eventModal{{ event.id }}" role="button" class="btn btn-info btn-mini" data-toggle="modal">
                                <i class="icon-edit"></i>
                            </a>

                            <div class="modal hide fade" id="eventModal{{ event.id }}" tabindex="-1" role="dialog" aria-labelledby="event-label" aria-hidden="true">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                    <h3 id="event-label">{% trans "Change Time Contribution" %}</h3>
                                </div>
                                <div class="modal-body">
                                    <form class="validateMe"  class="eventForm{{ event.id }} validateMe" enctype="multipart/form-data" action="{% url "change_exchange_work_event" event_id=event.id %}" method="POST" >
                                        {% csrf_token %}
                                        {% with event.changeform as form %}
                                          <label>{{ form.event_date.label }}:</label> {{ form.event_date }}
                                          {% if form.event_date.help_text %}<br/><span class="helptext">{{ form.event_date.help_text }}</span>{% endif %}
                                          <label>{{ form.ocp_skill_type.label }}:</label> {{ form.ocp_skill_type }}
                                          {% if form.ocp_skill_type.help_text %}<br/><span class="helptext">{{ form.ocp_skill_type.help_text }}</span>{% endif %}
                                          <label>{{ form.from_agent.label }}:</label> {{ form.from_agent }}
                                          {% if form.from_agent.help_text %}<br/><span class="helptext">{{ form.from_agent.help_text }}</span>{% endif %}
                                          <label>{{ form.quantity.label }}:</label> {{ form.quantity }}
                                          {% if form.quantity.help_text %}<br/><span class="helptext">{{ form.quantity.help_text }}</span>{% endif %}
                                          <label>{{ form.is_contribution.label }}:</label> {{ form.is_contribution }}
                                          {% if form.is_contribution.help_text %}<br/><span class="helptext">{{ form.is_contribution.help_text }}</span>{% endif %}
                                          <label>{{ form.description.label }}:</label> {{ form.description }}
                                        {% if form.description.help_text %}<br/><span class="helptext">{{ form.description.help_text }}</span>{% endif %}
                                        {% endwith %}

                                        <input type="hidden" id="next" name="next" value="exchange-work" />
                                        <div class="modal-footer">
                                            <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                            <input type="submit" class="btn btn-primary" name="submit" value='{% trans "Save" %}' />
                                        </div>
                                    </form>
                                </div>
                            </div>

                            <form
                                style="display: inline;"
                                class="delete-form"
                                id="deleteForm{{ event.id }}"
                                action="{% url "delete_event" event_id=event.id %}"
                                method="POST" >
                                {% csrf_token %}
                                <input type="hidden" id="next" name="next" value="exchange-work" />
                                <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete work contribution!" >X</button>
                            </form>
                          {% endif %}
                        {% endif %}
                        {% if event.description %}
                        <div class="notes"> {{ event.description|urlize|linebreaks }} </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            {% endif %}
          {% endif %}
        </div>
        {% endwith %}
    </div>
</div>

{% endblock %}
{% block extra_script %}
	<script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
	<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.10.0/jquery.validate.min.js"></script>
	<script src="{% static 'js/chosen.jquery.js' %}"></script>
{% endblock %}

{% block extra_body %}
	{{ block.super }}

    <script type="text/javascript">

	$(document).ready(function(){
      var ObjChosSingle = {
        allow_single_deselect: true,
        width: "250px",
        //no_results_text: "Oops, nothing found!",
        disable_search_threshold: 6
      };
      /*var ObjChos = {
        //allow_single_deselect: true,
        width: "290px",
        no_results_text: "Oops, nothing found!",
        max_selected_options: 1,
        disable_search_threshold: 6,
      };*/

      $(".chzn-select").each(function(){
        $(this).chosen( ObjChosSingle );
      });

      //$(".chzn-results").menu();

      $('.date-entry').datepicker({ dateFormat: "yy-mm-dd" });

      $('#work-info').popover();
      $('#xfer-info').popover();
      $('#rxfer-info').popover();

      $('.modal').find('select[name$=to_agent]').add('select[name$=from_agent]').addClass('related_agent');

		  jQuery.validator.addMethod("quantity",
            function(value, element) {
                var isValidQuantity = /^\d{0,6}(\.\d{0,2})?$/.test(value);
                return this.optional(element) || isValidQuantity;
            },
            "Please enter a number less than 1000000 with no more than 2 decimal places"
        );

        jQuery.validator.setDefaults({
            success: function(label) {
		        label
			        .text('').addClass('valid')
			        .closest('.control-group').addClass('success');
	        }
        });

        $.validator.addClassRules("quantity", { required: true, quantity: true, });
        //$.validator.addClassRules("value", { required: true, number: true });
		    $.validator.addClassRules("url", { url: true });
        $.validator.addClassRules("resourceType", { required: true});
        $.validator.addClassRules("hours", {
			    required: true,
			    number: true,
			    min: 0,
			    max: 24
		    });
		    $.validator.addClassRules("minutes", {
			    required: true,
			    number: true,
			    min: 0,
			    max: 60
		    });
        $.validator.addClassRules("date-entry", { required: true, date: true });

        //$.validator.addClassRules("related_agent", { required: true });

        $.validator.addMethod("agentRequired", function (value, element) {
            var form_id = element.form.id;
            form_id = "#" + form_id;
            var parent = element.parentElement;
            var parentSib = parent.nextElementSibling;
            var sib = parentSib.children[0];
            var sibValue = sib.value;
            if (sibValue){
                var sibId = sib.id;
                sibId = "#" + sibId;
                $(sibId).removeClass('error').next('label.error').remove();
            }
            return this.optional(element) || sibValue;
        }, "Both role and agent must be selected.");

    $.validator.addMethod("roleRequired", function (value, element) {
            var form_id = element.form.id;
            form_id = "#" + form_id;
            var parent = element.parentElement;
            var parentSib = parent.previousElementSibling;
            var sib = parentSib.children[0];
            var sibValue = sib.value;
            if (sibValue){
                var sibId = sib.id;
                sibId = "#" + sibId;
                $(sibId).removeClass('error').next('label.error').remove();
            }
            return this.optional(element) || sibValue;
        }, "Both role and agent must be selected.");

    $.validator.addClassRules("select-role", { agentRequired: true });
    $.validator.addClassRules("select-agent", { roleRequired: true });

    $('.validateMe').each( function(){
			var form = $(this);
			form.validate({
				highlight: function(label) {
					$(label).closest('.control-group').addClass('error');
				}
			});
		});

    $("#btnAddReceipt").click(setReceiptModal);
    $("#btnAddMaterial").click(setMaterialModal);

    function setReceiptModal() {
      var targetId = "id_unorderedreceipt-resource_type";
      var resourceTypeId = $("#id_unorderedreceipt-resource_type").val()
      //alert("onload rtid " + resourceTypeId);
      JsonSetUnitAndRule(resourceTypeId, targetId);
    };

    function setMaterialModal() {
      var targetId = "id_material-resource_type";
      var resourceTypeId = $("#id_material-resource_type").val()
      //alert("onload rtid " + resourceTypeId);
      JsonSetUnitAndRule(resourceTypeId, targetId);
    };

	  $(".resource-type-selector").change(getUnitAndRule);

		function getUnitAndRule(event) {
	      $(".chzn-select").trigger("liszt:updated");
		    var resourceTypeId = event.target.value;
            //alert("rt " + resourceTypeId);
		    if (resourceTypeId) {
                var targetId = event.target.id;
                //alert("targetId " + targetId);
                JsonSetUnitAndRule(resourceTypeId, targetId);
		    }
	   }

	   $(".ocp-resource-type-for-resource").chosen().change( function(evt, params){

          getResources( evt, params );
     });

     function getResources(event) {
            var resourceTypeId = event.target.value; //alert('resourceTypeId: '+resourceTypeId);
            if (resourceTypeId)
            {
                var targetId = event.target.id;
                var prefix = targetId.split('-')[0];
                var resourceFieldId = "#" + prefix + "-resource"; //alert($(resourceFieldId).html());
                $(resourceFieldId).empty();

                var jsonUrl = encodeURI("/work/json-resourcetype-resources-locations/" + resourceTypeId + "/");
                $.get(jsonUrl,
                    function(data){
                    $(resourceFieldId).append('<option value="">' + '. . .' + '</option>');
                    for(var i=0 ; i<data.length ; i++)
                    {
                        var id = data[i].fields['pk'];
                        var name = data[i].fields['identifier'];
                        var loc = data[i].fields['location'];
                        if (loc){
                            name = name + " at " + loc;
                        }
                        $(resourceFieldId).append('<option value="' + id + '">' + name + '</option>')
                    }
                    $(resourceFieldId).trigger("chosen:updated");
                });
            }
      }


      if($( '#use-case' ).val() == 'res_contr' || $( '#use-case' ).val() == 'cash_contr') {
            $( '#div_id_supplier' ).hide();
      } else {
            $( '#div_id_supplier' ).show();
      }

      /*$('#receiptForm').click(function (event) {
            var isValid = $("#receiptForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });

      $('#paymentForm').click(function (event) {
            var isValid = $("#paymentForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });

      $('#expenseForm').click(function (event) {
            var isValid = $("#expenseForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });*/

      $('#workForm').click(function (event) {
        var isValid = $("#workForm").validate();
        if (!isValid) {
          event.preventDefault();
        }
      });

      /*$('#cashForm').click(function (event) {
            var isValid = $("#cashForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });

      $('#materialForm').click(function (event) {
            var isValid = $("#materialForm").validate();
            if (!isValid) {
                event.preventDefault();
            }
      });*/

		  $( "#help" ).toggle( function(){
            $('#help-content').show("slide", { direction: "right" }, "slow" );
            $( "#help" ).text("Hide Help");
      }, function() {
            $('#help-content').hide("slide", { direction: "right" }, "slow");
            $( "#help" ).text("Show Help");
      })

      {% if use_case.identifier == 'sale' %}
            $("#id_context_agent").change(getCustomers);
      {% endif %}


	}); // end document.ready

  function JsonSetUnitAndRule(resourceTypeId, targetId) {
	    if (targetId.search("usable") >= 0) {
		    direction = "use";
	    }
	    else {
		    direction = "other";
	    }
	    var prefix = targetId.split('-')[0];
	    var unitName = "#" + prefix + "-unit_of_quantity";
	    var jsonUrl = encodeURI("/accounting/json-directional-unit-and-rule/" + resourceTypeId + "/" + direction + "/");
	    $.get(jsonUrl,
		    function(data){
			    var unit = data["unit"];
                $(unitName).val(unit);
                var inventory_rule = data["rule"];
                //alert(inventory_rule);
                if (inventory_rule == "yes") {
                    //$('#div_id_unorderedreceipt-quantity').show();
                    //$('#div_id_unorderedreceipt-unit_of_quantity').show();
                    $('#div_id_unorderedreceipt-identifier').show();
                    $('#div_id_unorderedreceipt-url').show();
                    $('#div_id_unorderedreceipt-photo_url').show();
                    $('#div_id_unorderedreceipt-notes').show();
                    $('#div_id_unorderedreceipt-current_location').show();
                    $('#div_id_unorderedreceipt-access_rules').show();
                    $('.hideShow').show();
                } else {
                    //$('#div_id_unorderedreceipt-quantity').hide();
                    //$('#div_id_unorderedreceipt-unit_of_quantity').hide();
                    $('#div_id_unorderedreceipt-identifier').hide();
                    $('#div_id_unorderedreceipt-url').hide();
                    $('#div_id_unorderedreceipt-photo_url').hide();
                    $('#div_id_unorderedreceipt-notes').hide();
                    $('#div_id_unorderedreceipt-current_location').hide();
                    $('#div_id_unorderedreceipt-access_rules').hide();
                    $('.hideShow').hide();
                }
		    });
  };

  {% if use_case.identifier == 'sale' %}
    function getCustomers() {
        $(".chzn-select").trigger("liszt:updated");
        var selectedAgent = document.getElementById('id_context_agent').value;
        var jsonUrl = encodeURI("/accounting/json-context-agent-customers/" + selectedAgent + "/");
        var selectedCustomer = document.getElementById('id_customer').value;
        //var customerField =  $("#id_customer");
        $("#id_customer").empty();
        $.get(jsonUrl,
        function(data){
            $("#id_customer").append('<option value="">' + '--------' + '</option>');
            for(var i=0 ; i<data.length ; i++)
            {
                var id = data[i]['pk'];
                var name = data[i].fields['nick'];
                if (selectedCustomer == id) {
                    $("#id_customer").append('<option value="' + id + '" selected>' + name + '</option>');
                } else {
                    $("#id_customer").append('<option value="' + id + '">' + name + '</option>');
                }
            }
            $(".chzn-select").trigger("liszt:updated");
        });
    };
  {% endif %}

  </script>

{% endblock %}
