{% extends "work_base.html" %}

{% load staticfiles %}
{% load i18n %}
{% load bootstrap_tags %}
{% load mptt_tags %}
{% load filters %}
{% load comments %}

{% block head_title %}{% trans "Exchanges" %}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css" />
<link rel="stylesheet" href="{% static 'css/chosen.css' %}" />
<link rel="stylesheet" href="{% static 'css/skin-lion/ui.fancytree.min.css' %}" />

<style>

ul, li {
  min-height: 23px;
}
ul.xlist {
  list-style: none;
  margin-left: 0;
}
ul.tlist {
  list-style: none;
  margin-left: 1.4em;
}
span.pending, span.complete, span.empty {
  display: inline;
  /*float: left;*/
  padding: 0 0.1em 0 0;
}
/*h3 {
    font-size: 19.5px;
}*/


.totals {
    /*border: solid 2px firebrick;
    background-color: oldlace;
    margin-bottom: 12px;
    padding-left: 1em;
  padding-top: 16px;
  padding-bottom: 16px;
  max-width: 323px;
  float: right;
  width: 310px;
  margin-left: 16px;*/
  display: inline-block;
}
.totals table {
  position: relative;
  border: none;
}
.totals table thead {
  border-bottom: 1px solid #ddd;
}
.totals table thead th {
  border: none;
}
.totals table tbody tr {
  border-top: 1px solid #ddd;
}
.totals table tbody tr:first-child {
  border-top: none;
}
.totals table tr td {
  border: none;
  border-left: 1px solid #ddd;
  padding: 5px 10px;
  text-align: right;
  /*font-weight: bold;*/
}
.totals table tr th {
  border: none;
  text-align: right;
  padding: 5px 10px;
  color: #476B6B;
  border-right: 1px solid #ddd;
  font-weight: normal;
}
.totals table tr:first-child th {
  /*border-right: none;*/
  padding: 0 10px;
  text-align: left;
}
.totals table tbody th {
    border-left: none;
}
.totals table tbody tr:last-child td, .totals table tbody tr:last-child th {
    border-bottom: none;
}
.totals table tr th:last-child, .totals table tr td:last-child {
  border-right: none;
}
.totals table tr th h4 {
  line-height: 9px;
}
span.total {
  font-weight: bold;
  font-size: 105%;
  padding: 4px 10px;
  display: inline-block;
}
#btn-export {
    margin-bottom: 8px;
}
.title {
    font-size: 1.1em;
    font-weight: bold;
  color: #476B6B;
}
.table thead th {
    vertical-align: top;
}
.table thead th .sub-th {
    font-size: 90%;
    color: grey;
    line-height: 1.2em;
    display: inline-block;
}
.exlist table.dataTable {
    border-collapse: collapse !important;
}
.exlist table.dataTable th {
    padding: .3rem .7rem;
}
.exlist table.dataTable thead .sorting::after,
.exlist table.dataTable thead .sorting_asc::after, .exlist table.dataTable thead .sorting_desc::after {
    top: 30px;
    right: 5px;
}
.exlist table.dataTable thead .sorting::before,
.exlist table.dataTable thead .sorting_asc::before, .exlist table.dataTable thead .sorting_desc::before {
    top: 30px;
    right: 12px;
}
.dt-buttons {
    float: right;
}
div.dataTables_filter, div.dt-buttons, div.dataTables_info, div.dataTables_length, div.row > div.col > div.dataTables_paginate {
    margin-top: 10px;
}
div.row > div.col >  div.dataTables_paginate ul.pagination {
    justify-content: flex-start;
}
/*div.dataTables_wrapper div.dataTables_info {
    padding-top: inherit !important;
}
div.dataTables_length {
    float: right;
    margin-right: 4em;
}*/

td.qty {
    text-align: right;
}
th.give {
    background-color: #F5F5F0;
}

small {
  font-size: 90%;
}

#exchangeTypeForm {
  /*min-height: 20px;*/
}

#new_exchange {
  /*float: left;
  margin-left: 13px;
  max-width: 797px;*/
  width: 100%;
  /*text-align: right;*/
}

.use-case {
  width: 140px;
}
/*#new_exchange #exchangeForm > div#id_exchange_type_chzn, #exchangeForm > div#id_resource_type_chzn, div#id_skill_type_chzn {
  min-width: 300px;
}
#new_exchange .chzn-drop {
  min-width: 298px;
}
#new_exchange .chzn-drop .chzn-search input {
  min-width: 263px;
}*/


#new_exchange .chzn-container .chzn-results li {
  padding: 4px 6px 0;
}


#new_exchange select {
  margin: 4px;
}
#new_exchange .chosen-container {
  /*margin-top: 5px;*/
  display: inline-table;
  text-align: left;
  margin: 5px 2px;
  display: inline-table;

}
#resource_skill .chosen-container {
  float: left;
}

#new_exchange .chosen-choices li.search-choice {
  width: 88%;
}

hr {
  margin: 5px 0 12px;
}

.span12 {
  margin-left: 0px;
  /*max-height: 97px;*/
}
.miniform {
    margin-bottom: 0;
  /*margin-left: 0px;
  float: left;*/
}

#exchangeForm p {
  margin: 0 0 5px;
}
.filter {
  float: right;
  max-width: 355px;
}

.showhide {
  color: #734279;
  margin-left: 3px;
  font-weight: bold;
  cursor: pointer;
}

.errorlist {
  list-style: outside none none;
  margin: 0px;
}
.alert {
  padding: 7px 13px 4px;
  border-color: #c0a873;
}

.alert ul, .alert li {
  display: inline-block;
  padding: 0;
  margin: 0;
}


/* TABS */
.ui-tabs h4 {
  display: inline-block;
  vertical-align: top;
  margin-top: 12px;
}
.ui-tabs {
  border: none;
  background: none;
}
.ui-widget {
  font-size: inherit;
  font-family: inherit;
  padding: inherit;
}
.ui-tabs .ui-tabs-nav {
  display: inline-block;
  border: none;
  background: none;
  margin: 0 0 -2px 0 !important;
  padding-left: 0px;
}
.ui-tabs .ui-tabs-panel {
  border: 1px solid #aaaaaa;
  padding: 7px 12px;
  color: inherit;
  background-color: #f0f0da;
  -moz-border-radius-bottomright: 7px;
  -webkit-border-bottom-right-radius: 7px;
  -khtml-border-bottom-right-radius: 7px;
  border-bottom-right-radius: 7px;

  -moz-border-radius-bottomleft: 7px;
  -webkit-border-bottom-left-radius: 7px;
  -khtml-border-bottom-left-radius: 7px;
  border-bottom-left-radius: 7px;

  -moz-border-radius-topright: 7px;
  -webkit-border-top-right-radius: 7px;
  -khtml-border-top-right-radius: 7px;
  border-top-right-radius: 7px;

  /*-moz-border-radius-topleft: 7px;
  -webkit-border-top-left-radius: 7px;
  -khtml-border-top-left-radius: 7px;
  border-top-left-radius: 7px;*/

  margin-top: -1px;
  margin-bottom: 10px;
}
.ui-tabs .ui-tabs-nav li {
  margin-bottom: 1px;
  font-size: 1.0em;
  background-color: #f0f0da;
}
.ui-tabs-nav a {
  color: inherit;
}
.ui-widget-content a {
  color: #fff;
}
.ui-widget-content a.disabled {
  color: inherit;
}
.ui-state-default a, .ui-state-default a:link, .ui-state-default a:visited {
  color: #734279;
}
.ui-state-active a, .ui-state-active a:link, .ui-state-active a:visited {
  color: #476B6B;
}
.ui-state-active, .ui-widget-content .ui-state-active, .ui-widget-header .ui-state-active {
  background: none;
  background-color: #f0f0da;
}
.ui-tabs .ui-tabs-nav li.ui-tabs-active {
    margin-bottom: -2px;
    padding-bottom: 2px;
}

.usecase_tab {
  padding: 10px;
}


.chosen-container-multi .chosen-choices li.search-choice span {
  /*line-height: 1.3em;*/
}

/*  MODALS  */

.modal-field {
  margin-bottom: 8px;
}
#new_exchange .modal-field .chosen-container {
  margin: inherit;
}

</style>

{% endblock %}

{% block body_class %}exchange{% endblock %}

{% block body_base %}
<div class="container">
        {% include "_messages.html" %}
		<legend>
        <a class="indent" href="{% url 'members_agent' agent_id=context_agent.id %}">{{ context_agent.name }}</a> > {% trans "Exchanges" %}
            <div class="subnav">
              {% if request.user.is_staff or request.user.agent.agent in context_agent.managers or request.user.agent.agent == context_agent %}
                {% if context_agent.faircoin_resource %}
                  <a class="indent" href="{% url "manage_faircoin_account" resource_id=context_agent.faircoin_resource.id %}">{% trans "Wallet" %}</a>
                {% endif %}
                <a class="indent" href="{% url "project_resources" agent_id=context_agent.id %}">{% trans "Resources" %}</a>
                {% if request.user.agent.agent in context_agent.managers %}
                    {% if context_agent.project.fobi_slug and context_agent.project.join_requests %}
                      <a class="indent" href="{% url 'join_requests' agent_id=context_agent.id %}">{% trans "Join Requests" %}</a>
                    {% endif %}
                {% endif %}
              {% endif %}
              {% if request.user.agent.agent.need_projects %}
                  <!-- <a class="indent" href="{% url "your_projects" %}">{% trans "Your Projects" %}</a> -->
              {% endif %}
            </div>
        </legend>
    <div class="container span12" style="padding: 0px;">
      <div class="row no-gutters" style="width: 100%;">
        <div class="col-sm span8" style="margin-left:0;">
          {% if request.user.agent.agent in context_agent.managers or request.user.agent.agent == context_agent or request.user.is_superuser %}
            <div class="totals infobox" style="min-width:320px; padding-bottom:13px;">
              <span class="showhide" id="sh-totals" style="float:right;">(SHOW)</span>
              <h3>
              {% trans "Totals:" %}
              </h3>
              {% if not exchanges_by_type %}
                <p>
                  {% trans "There are no exchanges to count..." %}
                </p>
              {% else %}
              <table class="totalbox">
                <thead>
                  <tr>
                    <th> &nbsp; </th>

                    {% for tt in total_transfers %}
                      {% if tt.name %}
                        <th>
                              <b style="font-size:110%">{{ tt.name }}:</b>
                        </th>
                      {% endif %}
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <th style="min-width: 65px; text-align:right; padding: 5px 10px;">
                      <span class="list" id="list-totals_B"><b style="font-size:110%">{% trans "Balance:" %}</b></span>
                    </th>
                    {% for tt in total_transfers %}
                      {% if tt.name %}
                          <td> <b style="">{{ tt.balance|safe }}</b>{% if tt.balnote %}<br/>? {{ tt.balnote }} {{ tt.abbr }}{% elif not tt.balance|first == '<' %}&nbsp;<b>{{ tt.abbr }}</b> {% elif '' == '>' %}
                              {% endif %}</td>
                      {% endif %}
                    {% endfor %}
                  </tr>
                  <tr id="list-totals1" class="list">
                    <th>
                      <b>{% trans "Incoming:" %}</b><br/><small>{% trans "commited" %}:</small>
                    </th>
                    {% for tt in total_transfers %}
                      {% if tt.name %}
                        <td> +&nbsp;{{ tt.income }}&nbsp;{{ tt.abbr }}<br/>{% if tt.incommit %}({{ tt.incommit }}&nbsp;{{ tt.abbr }}){% else %}&nbsp;{% endif %}</td>
                      {% endif %}
                    {% endfor %}
                  </tr>
                  <tr id="list-totals2" class="list">
                    <th>
                      <b>{% trans "Outgoing:" %}</b><br/><small>{% trans "commited" %}:</small>
                    </th>
                    {% for tt in total_transfers %}
                      {% if tt.name %}
                          <td> -&nbsp;{{ tt.outgo }}&nbsp;{{ tt.abbr }}<br/>{% if tt.outcommit %}({{ tt.outcommit }}&nbsp;{{ tt.abbr }}){% else %}&nbsp;{% endif %}</td>
                      {% endif %}
                    {% endfor %}
                  </tr>
                  {% if request.user.is_superuser %}
                  <tr id="list-totals3" class="list">
                    <th style="background:none; text-align:left;">
                        (debug:)
                    </th>
                    {% for tt in total_transfers %}
                      {% if tt.name %}
                          <td style="text-align:left;"><small>{{ tt.debug }}</small></td>
                      {% endif %}
                    {% endfor %}

                  </tr>
                  {% endif %}


                </tbody>
              </table>
              {% endif %}
              <!-- <span class="total">Incoming total: {{ total_transfers }} </span><br/>
              <span class="total">Outgoing total: {{ total_rec_transfers }} </span>

              <br />{% trans "* Note these totals are meaningful only if the events selected all use the same currency. <br/>(We'll do a multi total per unit-type box soon)" %} -->

            </div>
          {% endif %}
        </div>

        <div class="col-sm span4">

          <div class="filter miniform">
            {% comment %}
            {% if exchanges %}
                <div>
                    <a href=" {% url "exchange_events_csv" %}?event-ids={{ event_ids }}" id="btn-export" class="btn btn-primary" title="Export filtered list to csv (comma separated value) format" >{% trans "Export CSV File" %}</a>
                </div>
            {% endif %}
            {% endcomment %}
            <h3 style="margin-bottom:8px;">{% trans "Filters:" %}</h3>
            <form id="filter-form" action="." method="POST" style="margin-bottom:6px;">
	            {% csrf_token %}
                <div id="div_id_start_date" class="control-group" style="display:inline-block; margin-bottom:0;" >
                    <label for="id_start_date" class="control-label required-field" style="display:inline-block;" >
                        {% trans "Start:" %}
                    </label>
                    <div class="controls" style="display: inline-flex;" >
                        {{ dt_selection_form.start_date }}
                    </div> &nbsp;
                </div>
                <div id="div_id_end_date" class="control-group" style="display:inline-block; margin-bottom:0;" >
                    <label for="id_end_date" class="control-label required-field" style="display:inline-block;" >
                        {% trans "End:" %}
                    </label>
                    <div class="controls" style="display: inline-flex;" >
                        {{ dt_selection_form.end_date }}
                    </div>
                </div>
	            <div class="list" id="list-filter_by_type" style="display:none;">
                <p><span class="title"> {% trans "Filter by Type" %}:</span>
                </p>
                <p><input type="checkbox" class="category" id="all" name="all" value="all" {% if select_all %}checked="yes"{% endif %} /> {% trans "All in the date range" %}</p>
                {% for x in exchanges_by_type %}
                  {% if user.is_staff or request.user.agent.agent in context_agent.managers or request.user.agent.agent in x.related_agents %}
                    {% with x.exchange_type as et %}
                      {% with et.ocp_record_type.get_ancestors|slice:"5:6"|first as useca %}
                        {% ifchanged useca %}
                          <h5>{{ useca.name }}</h5>
                        {% endifchanged %}
                      {% endwith %}
                      {% ifchanged et.ocp_record_type and et.ocp_record_type.name %}
                        <p><input type="checkbox" class="category" id="{{ et.id }}" name="{{ et.id }}" value="{{ et.id }}" /> {% if not et.ocp_record_type %}{{ et }} (!){% else %}{{ et.ocp_record_type.name }}{% endif %}</p>
                      {% endifchanged %}
                    {% endwith %}
                  {% endif %}
                {% endfor %}
                </div>

{% comment %}
                {% if references %}
	            <p class="title"> {% trans "Accounting Reference" %} </p>
	            {% for ar in references %}
	                <p><input type="checkbox" class="category" id="{{ ar.code }}" name="{{ ar.code }}" value="{{ ar.code }}" /> {{ ar.name }}</p>
	            {% endfor %}
	            {% endif %}
{% endcomment %}

                <div style="float:right; margin-top:5px;">
                    <span class="title"> {% trans "by type:" %}</span> &nbsp; <span class="showhide" id="sh-filter_by_type" >(SHOW)</span>
                </div>
	            <input type="hidden" id="categories" name="categories" value=" {{ selected_values }} " />
	            <input type="submit" id="btn-filter" name="submit" class="btn btn-info" value="{% trans 'Filter' %}"
                       style="float:left; margin-bottom:5px;"/>
            </form>
          </div>
        </div>
      </div>
    </div>
    <div class="span12">

      <!-- </div> -->
      <div class="exlist" style="">
      {% if exchanges_by_type %}
        <h3>
          {% trans "List of Exchanges" %}{% if not user.is_staff and not request.user.agent.agent in context_agent.managers and not request.user.agent.agent == context_agent %}
            <span>({% trans "related to you" %})</span>
            {% endif %}: &nbsp;<span style="font-size:80%" class="small">({% trans "listing" %} {{ exchanges.count }} of {{ exchanges_by_type.count }})</span>
        </h3>
        <table id="exchanges" style="width: 100%;" class="table table-bordered table-hover table-condensed cell-border order-column stripe" >
        <thead>
            <th>{% trans "State" %}</th>
            <th>{% trans "Date" %}</th>
            <th>{% trans "Action" %}</th>
            <th>{% trans "Agent" %}</th>
            <th class="give">{% trans "Give" %}<br/>
                <span class="sub-th">{% trans "Qty" %}</span>
            </th>
            <th class="give"><br/><span class="sub-th">{% trans "Resource" %}</span></th>
            <th class="give"><br/><span class="sub-th">{% trans "Last date" %}</span></th>
            <th class="receive" style="padding-right:5px;">{% trans "Receive" %}<br/>
                <span class="sub-th">{% trans "Qty" %}</span>
            </th>
            <th class="receive"><br/><span class="sub-th">{% trans "Resource" %}</span></th>
            <th class="receive"><br/><span class="sub-th">{% trans "Last date" %}</span></th>
        </thead>
        <tbody>
        {% for x in exchanges %}
            {% if request.user.agent.agent in context_agent.managers or request.user.agent.agent == context_agent or request.user.is_superuser %}
                <tr>
                    <td>

                            <a href="{% url "exchange_logging_work" context_agent_id=context_agent.id exchange_type_id=0 exchange_id=x.id %}"
                               class="{{ x.statuss }}" >
                                {{ x.statuss|title }}
                            </a>

                        {% if user == x.created_by or user.is_superuser%}
                            <!-- <a class="btn btn-info btn-mini" href="{% url "exchange_logging_work" context_agent_id=context_agent.id exchange_type_id=0 exchange_id=x.id %}">{% trans "Change" %}</a> -->
                            {% if x.is_deletable %}
                                <form
                                    style="display: inline;"
                                    class="delete-form"
                                    id="deleteForm{{ exchange.id }}"
                                    action="{% url "delete_exchange" exchange_id=x.id %}"
                                    method="POST" >
                                    {% csrf_token %}
                                    <input type="hidden" id="next" name="next" value="exchanges-all" />
                                    <button style="display: inline;"  class="btn btn-warning btn-mini" title="Delete contribution" >{% trans "X" %}</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td>
                        {{ x.start_date|date:"Y-m-d" }}
                    </td>
                    <td>
                        {{ x.exchange_type|show_name:context_agent|safe }}
                        {% if x.join_request %}
                            {% get_comment_count for x.join_request as ncom %}
                            <a href="{% url "project_feedback" agent_id=context_agent.id join_request_id=x.join_request.id %}"
                               class="btn-mini-icon"><i class="icon-comment" style="margin: 2px 3px 0px -1px;"></i>{{ ncom }}</a>
                        {% else %}

                        {% endif %}
                    </td>
                    <td class="agent">
                        {% if x.join_request %}
                            {% if context_agent == x.join_request.project.agent %}
                                <a href="{% url "members_agent" agent_id=x.join_request.agent.id %}" style="font-weight:bold;">
                                    {{ x.join_request.agent.name }}
                                </a>
                            {% else %}
                                <a href="{% url "members_agent" agent_id=x.join_request.project.agent.id %}"
                                   style="font-weight:bold;">
                                    {{ x.join_request.project.agent.name }}</a>
                            {% endif %}

                        {% else %}
                            {% if x.txpay %}
                                {% if x.txpay.to_agent == context_agent %}
                                  {% if x.txpay.from_agent %}
                                    <a href="{% url "members_agent" agent_id=x.txpay.from_agent.id %}" style="font-weight:bold;">
                                        {{ x.txpay.from_agent }}</a>
                                  {% else %}
                                    {% trans "?" %}
                                  {% endif %}
                                {% elif x.txpay.to_agent %}
                                    <a href="{% url "members_agent" agent_id=x.txpay.to_agent.id %}" style="font-weight:bold;">
                                        {{ x.txpay.to_agent }}</a>
                                {% else %}
                                    {% trans "?" %}
                                {% endif %}
                            {% else %}
                                {% for ag in x.related_agents %}
                                    {% if ag and not ag == context_agent %}
                                        <a href="{% url "members_agent" agent_id=ag.id %}" style="font-weight:bold;">
                                                    {{ ag }}</a>
                                        {% if ag and not forloop.last %}<br/>{% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endif %}

                    </td>
                    <td class="give qty">
                        {% if x.slots %}
                            {% for slot in x.slots %}
                                {% if context_agent in slot.agents_from %}
                                    {% if slot.total_com_unit %}
                                        {{ slot.total_com }}
                                    {% else %}
                                        z
                                    {% endif %}
                                {% elif not slot.agents_from %}
                                  {% if x.join_request %}
                                    {% if context_agent == x.join_request.agent %}
                                        jr:{{ x.join_request }}
                                    {% elif context_agent == x.join_request.project.agent %}
                                        {{ x.join_request.payment_amount }}
                                    {% else %}
                                        jr?:{{ x.join_request }}
                                    {% endif %}
                                  {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% else %}
                          ?
                        {% endif %}
                    </td>
                    <td class="give">
                        {% if x.slots %}
                            {% for slot in x.slots %}
                                {% if context_agent in slot.agents_from %}
                                    {% if slot.total_com_unit %}
                                        {{ slot.total_com_unit|safe }}
                                    {% else %}
                                        z
                                    {% endif %}
                                {% elif not slot.agents_from %}
                                  {% if x.join_request %}
                                    {% if context_agent == x.join_request.agent %}
                                        jr:{{ x.join_request }}
                                    {% elif context_agent == x.join_request.project.agent %}
                                        {{ x.join_request.project.shares_type }}
                                    {% else %}
                                        jr?:{{ x.join_request }}
                                    {% endif %}
                                  {% elif x.transfers.all|length == 1 %}
                                    {% with x.transfers.all|first as tx %}
                                      {% if tx.from_agent == context_agent %}
                                        <span class="{{ tx.status }}">&#9899;</span>
                                        {% if tx.quantity %}
                                            {{ tx.quantity }}
                                            {% if tx.actual_quantity and not tx.actual_quantity == tx.quantity %}({{ tx.actual_quantity }}){% endif %}
                                        {% elif tx.value %}
                                            {{ tx.value }}
                                            {% if tx.actual_value and not tx.actual_value == tx.value %}({{ tx.actual_value }}){% endif %}
                                        {% else %}
                                            n
                                        {% endif %}
                                      {% else %}
                                        <!-- tx:{{ tx }} -->
                                      {% endif %}
                                    {% endwith %}
                                  {% elif x.transfers.all|length > 1 %}
                                    <!-- txs:{{ x.transfers.all }} -->
                                  {% endif %}
                                {% else %}

                                {% endif %}
                            {% endfor %}
                        {% elif x.transfers.all %} tr!
                            {% for tx in x.transfers.all %}
                                {% if tx.from_agent == context_agent or x.join_request.project.agent == context_agent and not tx.from_agent %}
                                    <span class="{{ tx.status }}">&#9899;</span>
                                        {% if tx.quantity %}
                                            {{ tx.quantity }}
                                            {% if tx.actual_quantity and not tx.actual_quantity == tx.quantity %}({{ tx.actual_quantity }}){% endif %}
                                        {% elif tx.value %}
                                            {{ tx.value }}
                                            {% if tx.actual_value and not tx.actual_value == tx.value %}({{ tx.actual_value }}){% endif %}
                                        {% elif x.join_request %}
                                            {{ x.join_request.payment_amount }}
                                        {% else %}
                                            x
                                        {% endif %}
                                        {% if tx.resource %}
                                            {% if tx.resource.resource_type.ocp_artwork_type.is_account %}
                                                {% if tx.resource.resource_type.unit.name == 'Each' %}
                                                    {{ tx.resource.resource_type.unit_of_price }}
                                                {% else %}
                                                    {{ tx.resource.resource_type.unit }}
                                                {% endif %}
                                            {% else %}
                                                {{ tx.resource }}
                                            {% endif %}
                                        {% elif tx.resource_type %}
                                            {{ tx.resource_type }}
                                        {% else %}
                                            {% if tx.unit_of_quantity %}
                                                u:{{ tx.unit_of_quantity }}
                                            {% elif tx.transfer_type.is_share %}
                                                {{ tx.transfer_type.is_share.resource_type }}
                                            {% else %}
                                                ? {{ tx }}
                                            {% endif %}
                                        {% endif %}
                                        {% if tx and not forloop.last %}<br/>{%  endif %}
                                {% elif x.transfers.all|length == 1 %}
                                    <!-- <span class="{{ transfer.status }}">&#9679;</span>
                                        {{ transfer }} -->
                                {% endif %}
                                <!--({{ x.transfers.all|length }})-->

                            {% endfor %}
                        {% else %} empty
                        {% endif %}
                        {% if x.work_events %}
                            {% for event in x.work_events %}
                                {% if event.from_agent == context_agent %}
                                    {{ event }}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td class="give date">
                        {% if x.slots %}
                            {% for slot in x.slots %}
                                {% if context_agent in slot.agents_from %}
                                    <span class="{{ slot.status }}">&#9899;</span> {{ slot.last_date }}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td class="receive qty">
                        {% if x.slots %}
                            {% for slot in x.slots %}
                                {% if context_agent in slot.agents_to %}
                                    {% if slot.total_com_unit %}
                                        {{ slot.total_com }}
                                    {% else %}
                                        z
                                    {% endif %}
                                {% elif not slot.agents_to %}
                                  {% if x.join_request %}
                                    {% if context_agent == x.join_request.agent %}
                                        jr:{{ x.join_request.payment_amount }} {{ x.join_request.project.shares_type }}
                                    {% elif context_agent == x.join_request.project.agent %}
                                        {{ x.join_request.total_price }}
                                    {% endif %}
                                  {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td class="receive">
                        {% if x.slots %}
                            {% for slot in x.slots %}
                                {% if context_agent in slot.agents_to %}
                                    {% if slot.total_com_unit %}
                                        {{ slot.total_com_unit|safe }}
                                    {% else %}
                                        z
                                    {% endif %}
                                {% elif not slot.agents_to %}
                                  {% if x.join_request %}
                                    {% if context_agent == x.join_request.agent %}
                                        jr:{{ x.join_request.payment_amount }} {{ x.join_request.project.shares_type }}
                                    {% elif context_agent == x.join_request.project.agent %}
                                        {{ x.join_request.payment_unit }}
                                    {% endif %}
                                  {% elif x.transfers.all|length == 1 and slot.agents_from %}
                                    {% with x.transfers.all|first as tx %}
                                      {% if tx.to_agent == context_agent %}
                                        {% if tx.quantity %}
                                            {{ tx.quantity }}
                                            {% if tx.actual_quantity and not tx.actual_quantity == tx.quantity %}({{ tx.actual_quantity }}){% endif %}
                                        {% elif tx.value %}
                                            {{ tx.value }}
                                            {% if tx.actual_value and not tx.actual_value == tx.value %}({{ tx.actual_value }}){% endif %}
                                        {% else %}
                                            n
                                        {% endif %}
                                      {% else %}
                                        tx:{{ tx }}
                                      {% endif %}
                                    {% endwith %}
                                  {% elif x.transfers.all|length > 1 %}
                                    <!-- txs:{{ x.transfers.all }} -->
                                  {% endif %}
                                {% else %}

                                {% endif %}
                            {% endfor %}
                        {% elif x.transfers.all %} tr!
                            {% for tx in x.transfers.all %}
                                {% if tx.to_agent == context_agent or x.join_request.agent == context_agent and not tx.to_agent %}
                                    <span class="{{ tx.status }}">&#9899;</span>
                                    {% if tx.quantity %}
                                        {{ tx.quantity }}
                                        {% if tx.actual_quantity and not tx.actual_quantity == tx.quantity %}({{ tx.actual_quantity }}){% endif %}
                                    {% elif tx.value %}
                                        {{ tx.value }}
                                        {% if tx.actual_value and not tx.actual_value == tx.value %}({{ tx.actual_value }}){% endif %}
                                    {% elif x.join_request %}
                                        {{ x.join_request.payment_amount }}
                                    {% else %}
                                        x
                                    {% endif %}

                                    {% if tx.resource %}
                                        {% if tx.resource.resource_type.ocp_artwork_type.is_account %}
                                            {% if tx.resource.resource_type.unit.name == 'Each' %}
                                                {{ tx.resource.resource_type.unit_of_price }}
                                            {% else %}
                                                {{ tx.resource.resource_type.unit }}
                                            {% endif %}
                                        {% else %}
                                            {{ tx.resource }}
                                        {% endif %}
                                    {% elif tx.resource_type %}
                                        {{ tx.resource_type }}
                                    {% else %}
                                        {% if tx.unit_of_quantity %}
                                            u:{{ tx.unit_of_quantity }}
                                        {% elif tx.transfer_type.is_share %}
                                            {{ tx.transfer_type.is_share.resource_type }}
                                        {% else %}
                                            ? {{ tx }}
                                        {% endif %}
                                    {% endif %}
                                    {% if tx and not forloop.last %}<br/>{%  endif %}
                                {% endif %}
                            {% endfor %}
                        {% else %} empty
                        {% endif %}
                        {% if x.work_events %}
                            {% for event in x.work_events %}
                                {% if event.to_agent == context_agent %}
                                    {{ event }}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td>
                    <td class="receive date">
                        {% if x.slots %}
                            {% for slot in x.slots %}
                                {% if context_agent in slot.agents_to %}
                                    <span class="{{ slot.status }}">&#9899;</span> {{ slot.last_date }}
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    </td>
                </tr>
            {% endif %}
		{% endfor %}
        </tbody>
        </table>
      {% endif %}
      </div>

      <p> &nbsp; </p>

      {% if False and request.user.agent.agent in context_agent.managers or request.user.agent.agent == context_agent and request.user.is_superuser %}

            <div id="new_exchange" class="miniform">
            <form id="exchangeForm" style="margin:0; padding-bottom:11px;" method="POST" action="">
                <h3 style="display:inline-block;">{% trans "Create a new Exchange" %}:</h3> &nbsp;

                <br/>
                {% csrf_token %}
                {% if nav_form.used_exchange_type %}
                  <p>{% trans "Choose a previously used <b>Exchange Type</b> to copy the model:" %}
                  {{ nav_form.used_exchange_type }}</p>
                {% endif %}
                <p><span>{% trans "Or search an available exchange type:" %}</span>
                  {% if nav_form.exchange_type.errors and request.POST.new_exchange %}<div class="alert" style="display:inline-block;">{{ nav_form.exchange_type.errors }}</div>{% endif %}

                  {{ nav_form.exchange_type }}  &nbsp; <span>{% trans "Or make a new one..." %}</span><span class="showhide" id="sh-exchange_type" >(SHOW)</span></p>
                {% if Rtype_form.errors or Stype_form.errors and not request.POST.new_exchange and not request.POST.edit_exchange_type %}
                    {% if Rtype_form.errors %}{% if request.POST.new_resource_type or request.POST.edit_resource_type %}
                        <div class="alert" style="display:inline-block;"><ul><li>
                        {% trans "The new resource type request has some errors, click 'SHOW' to see them." %}</li></ul></div>{% endif %}
                    {% elif Stype_form.errors %}{% if request.POST.new_skill_type or request.POST.edit_skill_type %}
                        <div class="alert" style="display:inline-block;"><ul><li>
                        {% trans "The new skill type request has some errors, click 'SHOW' to see them." %}</li></ul></div>{% endif %}
                    {% endif %}
                {% endif %}
                <div class="list" id="list-exchange_type" style="margin-top: 5px;">
                  <div id="tabs" style="display:none;">
                    <ul>
                        {% for case in usecases %}
                        <li><a href="#{{ case.clas }}"><b>{{ case.name }}</b></a></li>
                        {% endfor %}
                    </ul>
                    <!-- <div style="float:right;">
                      {{ nav_form.exchange_type }}
                    </div> -->
                    {% for case in usecases %}
                      <div id="{{ case.clas }}" class="usecase_tab">
                        <div style="clear:both;">
                          {% if nav_form.exchange_type %}
                            <p>{% trans "...choosing a <b>use case</b>:" %}</p>
                              <div id="{{ case.clas }}_tree" class="exchange_type_tree fancytree-radio" style="max-width:300px;">
                                <ul class="root" id="treeData" style="/*display: none;*/">
                                {% recursetree Etype_tree %}
                                  {% if True or node.exchange_type or request.user.is_staff or not node.is_leaf_node %}
                                    {% if case.typ in node.get_ancestors %}
                                      <li id="Eid_{{ node.id }}" {% if node.ocpRecordType_ocp_artwork_type %}data-related="Rid_{{ node.ocpRecordType_ocp_artwork_type.id }}"{% endif %} {% if node.ocp_skill_type %}data-related="Sid_{{ node.ocp_skill_type.id }}"{% endif %} ><span>{% if not node.exchange_type %}<em>{% endif %}{{ node.name }}{% if node.exchange_type %} &lt; {% else %}</em>{% endif %}

                                        {% if node.exchange_type.created_by == request.user or request.user.is_superuser %} &nbsp; <span class="edit" id="Eid_{{ node.id }}"></span>
                                        {% endif %}
                                        </span>
                                        {% if not node.is_leaf_node %}
                                          <ul class="children">
                                              {{ children }}
                                          </ul>
                                        {% endif %}
                                      </li>
                                      {% if node.exchange_type.created_by == request.user or request.user.is_superuser %}
                                        <script type="text/javascript">
                                          var E_{{ node.id }}_obj = {
                                            "name":"{% if node.exchange_type %}{{ node.exchange_type.name }}{% else %}{{ node.name }}{% endif %}",
                                            "parent":"{{ node.parent.id }}",
                                            "description":"{{ node.exchange_type.description }}",
                                            "context":"{{ node.exchange_type.context_agent.id }}",
                                            "resource_type":"{{ node.ocpRecordType_ocp_artwork_type.id }}",
                                            "skill_type":"{{ node.ocp_skill_type.id }}",
                                          };
                                        </script>
                                      {% endif %}
                                    {% elif node.clas == case.clas %}
                                        {{ children }}
                                    {% endif %}
                                  {% endif %}
                                {% endrecursetree %}
                                </ul>
                              </div>

                              <span style="float:right;">
                                <ul style="display:inline-table; list-style:none; margin:7px 0;">
                                  <li class="edit_exchange_type" style="display:none;">{% trans "...you created this type:" %}&nbsp;<a href="#editExchangeTypeModal" id="edit_et_but" role="button" class="btn btn-primary btn-mini edit_exchange_type" data-toggle="modal" title="Edit a exchange type">{% trans "Edit" %}</a></li>
                                </ul>
                                {% if ext_form.errors %}{% if request.POST.edit_exchange_type %}<br>
                                <div class="alert" style="display:inline-block; float:right;"><ul>
                                  {% for fil in ext_form %}
                                  {% if fil.errors %}<li><em>{{ fil.label }}:</em> {{ fil.errors|first|safe }}</li>{% endif %}
                                  {% endfor %}
                                  </ul></div><br> &nbsp; <br> &nbsp; <br>
                                {% endif %}{% endif %}
                                <br> &nbsp;
                              </span>

                          {% else %}
                            <span class="error">{% trans "Not found any related exchange type! contexts:" %}</span>
                          {% endif %}
                        </div>
                      </div>

                  {% endfor %}
                  {% if nav_form.resource_type %}
                    <div id="resource_skill" style="display:inline-block; width:100%;">
                        <div style="clear:left;">
                          <p><span>{% trans "If you want to narrow your options," %}</span>
                          <span>{% trans "choose a main <b>Resource Type</b> branch:" %}</span>
                          </p>
                          <div id="resource_type_tree" class="resource_type_tree fancytree-radio" style="max-width:300px; min-width:200px; float:left; margin: 0px 0px 1px 1px;">
                            <ul class="root" id="treeData" style="/*display: none;*/">
                              {% recursetree Rtype_tree %}
                              {% if True or node.resource_type or request.user.is_staff %}
                                <li id="Rid_{{ node.id }}"><span>{% if not node.resource_type %}<em>{% endif %}{{ node.name }}{% if node.resource_type %} &lt; {% endif %} {% if not node.resource_type %}</em>{% endif %}
                                  {% if node.resource_type.created_by == request.user or request.user.is_superuser %}&nbsp; <span class="edit" id="Rid_{{ node.id }}"></span>
                                  {% endif %}
                                  </span>
                                  {% if not node.is_leaf_node %}
                                    <ul class="children">
                                      {{ children }}
                                    </ul>
                                  {% endif %}
                                </li>
                                {% if node.resource_type.created_by == request.user or request.user.is_superuser %}
                                  <script type="text/javascript">
                                    var R_{{ node.id }}_obj = {
                                      "name":"{% if node.resource_type %}{{ node.resource_type.name }}{% else %}{{ node.name }}{% endif %}",
                                      "parent":"{{ node.parent.id }}",
                                      "description":"{{ node.resource_type.description_str|safe }}",
                                      "context":"{{ node.resource_type.context_agent.id }}",
                                      "substi":"{{ node.resource_type.substitutable }}",
                                      "unit":"{{ node.resource_type.unit.ocp_unit_type.id }}",
                                      "price":"{% if node.resource_type.price_per_unit %}{{ node.resource_type.price_per_unit }}{% endif %}",
                                      "related":"{% if node.rel_material_type %}{{ node.rel_material_type.id }}{% elif node.rel_nonmaterial_type %}{{ node.rel_nonmaterial_type.id }}{% endif %}",
                                      "parentrecipe":"{{ node.resource_type.parent.id }}",
                                      "url":"{{ node.resource_type.url }}",
                                      "photo_url":"{{ node.resource_type.photo_url }}",
                                      {% if request.user.is_staff %}
                                        {% if not node.facet_value and not node.facet %}"n_desc" : "{{ node.get_descendant_count }}",{% endif %}
                                        {% if node.facet_value %}"fv" : "{{ node.facet_value.value|upper }}",
                                        {% elif node.facet %}"fv" : "{{ node.facet|upper }}",
                                        {% elif node.resource_type.facets %}"fv" : "{{ node.resource_type.facet_values_list }}",{% endif %}
                                      {% endif %}
                                    };
                                  </script>
                                {% endif %}
                              {% endif %}
                              {% endrecursetree %}
                            </ul>
                          </div>
                          <div style="display:block; ">
                            &nbsp; {{ nav_form.resource_type }} &nbsp;
                            <span>
                              <ul style="display:inline-table; list-style:none; margin:7px 0; float:right;">
                                <li>{% trans "...if nothing fits:" %}&nbsp; <a href="#addResourceTypeModal" role="button" class="btn btn-primary btn-mini btn_resource_type" data-toggle="modal" title="Create a new resource type" style="">{% trans "New Resource Type" %}</a></li>
                                <li class="edit_resource_type" style="display:none; margin-top:10px;">{% trans "...you created this type:" %}&nbsp;<a href="#addResourceTypeModal" id="edit_rt_but" role="button" class="btn btn-primary btn-mini edit_resource_type" data-toggle="modal" title="Edit a resource type">{% trans "Edit" %}</a></li>
                              </ul>
                              {% if Rtype_form.errors %}{% if request.POST.new_resource_type or request.POST.edit_resource_type %}<br>
                              <div class="alert" style="display:inline-block; float:right;"><ul>
                                {% for fil in Rtype_form %}
                                  {% if fil.errors %}<li><em>{{ fil.label }}:</em> {{ fil.errors|first|safe }}</li>{% endif %}
                                {% endfor %}
                              </ul></div><br> &nbsp; <br> &nbsp; <br>
                              {% endif %}{% endif %}
                              <br> &nbsp;
                            </span>
                          </div>
                        </div>
                        <!--<hr>-->
                        {% if request.user.is_superuser %}
                        <div style="clear:left; ">
                          <p>{% trans "Or choose a related <b>Skill Verb</b> (service time):" %}</p>

                          <div id="skill_type_tree" class="skill_type_tree fancytree-radio" style="max-width:300px; min-width:200px; float:left;  margin: 0px 0px 1px 1px;">
                            <ul class="root" id="treeData" style="/*display: none;*/">
                              {% recursetree Stype_tree %}
                              {% if True or node.resource_type or request.user.is_staff %}
                              <li id="Sid_{{ node.id }}"><span>{% if not node.resource_type %}<em>{% endif %}{{ node }}{% if node.resource_type %} {% endif %}{% if not node.resource_type %}</em>{% endif %}
                                {% if node.resource_type.created_by == request.user or request.user.is_superuser %}&nbsp; <span class="edit" id="Sid_{{ node.id }}"></span>
                                {% endif %}
                                </span>
                                {% if not node.is_leaf_node %}
                                <ul class="children">
                                  {{ children }}
                                </ul>
                                {% endif %}
                              </li>
                                {% if node.resource_type.created_by == request.user or request.user.is_superuser %}
                                  <script type="text/javascript">
                                    var S_{{ node.id }}_obj = {
                                      "name":"{% if node.resource_type %}{{ node.resource_type.name }}{% else %}{{ node.name }}{% endif %}",
                                      "parent":"{{ node.parent.id }}",
                                      "description":"{{ node.resource_type.description_str|safe }}",
                                      "context":"{{ node.resource_type.context_agent.id }}",
                                      //"substi":"{{ node.resource_type.substitutable }}",
                                      "unit":"{{ node.resource_type.unit.ocp_unit_type.id }}",
                                      "price":"{% if node.resource_type.price_per_unit %}{{ node.resource_type.price_per_unit }}{% endif %}",
                                      "related":"{{ node.ocp_artwork_type.id }}",
                                      //"parentrecipe":"{{ node.resource_type.parent.id }}",
                                      "url":"{{ node.resource_type.url }}",
                                      "photo_url":"{{ node.resource_type.photo_url }}",
                                      "verb":"{{ node.verb }}",
                                      "gerund":"{{ node.gerund }}",
                                      {% if request.user.is_staff %}
                                        {% if not node.facet_value and not node.facet %}"n_desc" : "{{ node.get_descendant_count }}",{% endif %}
                                        {% if node.facet_value %}"fv" : "{{ node.facet_value.value|upper }}",
                                        {% elif node.facet %}"fv" : "{{ node.facet|upper }}",
                                        {% elif node.resource_type.facets %}"fv" : "{{ node.resource_type.facet_values_list }}",{% endif %}
                                      {% endif %}
                                    };
                                  </script>
                                {% endif %}
                              {% endif %}
                              {% endrecursetree %}
                            </ul>
                          </div>
                          <div style="display:block; ">
                            &nbsp; {{ nav_form.skill_type }} &nbsp;
                            <span><!--<div style="display:inline-flex; float:right; position:absolute;">-->
                              <ul style="display:inline-table; list-style:none; margin:7px 0; float:right;">
                                <li>{% trans "...if no one fits:" %}&nbsp; <a href='#addSkillTypeModal' role="button" class='btn btn-primary btn-mini btn_skill_type' data-toggle="modal" title="Create a new skill resource type">{% trans "New Skill Service Type" %}</a></li>
                                <li class="edit_skill_type" style="display:none; margin-top:10px;">{% trans "...you created this skill:" %}&nbsp;<a href="#addSkillTypeModal" id="edit_st_but" role="button" class="btn btn-primary btn-mini edit_skill_type" data-toggle="modal" title="Edit a skill type">{% trans "Edit" %}</a></li>
                              </ul>
                              {% if Stype_form.errors %}{% if request.POST.new_skill_type or request.POST.edit_skill_type %}<br>
                               <div class="alert" style="display:inline-block; float:right;"><ul>
                                {% for fil in Stype_form %}
                                  {% if fil.errors %}<li><em>{{ fil.label }}:</em> {{ fil.errors|first|safe }}</li>{% endif %}
                                {% endfor %}
                               </ul></div><br> &nbsp; <br> &nbsp; <br>
                              {% endif %}{% endif %}
                            </span><!--</div>-->
                            <br> &nbsp; <br> &nbsp;
                          </div>
                        </div>
                        {% endif %}
                    </div> <!-- end resource_skill -->
                    <hr>
                    {% else %}
                    <div>
                      <span class="error">{% trans "Not found any related resource type!" %}</span>
                    </div>
                    {% endif %}
                </div> <!-- end tabs -->
              </div>
              {% if request.user.is_superuser %}<span style="font-size:0.8em;color:#666;">(debug) <b>RelAgents:</b> ({{ context_agent.related_contexts|length }}) <b>Contexts:</b> ({{ context_agent.related_all_agents|length }}) <span class="showhide" id="sh-debug_contexts" >SHOW</span>
                <div id="list-debug_contexts" class="list">
                    <b>Contexts:</b> {% for ag in context_agent.related_contexts %} {{ ag.name }} {% if not ag.nick == ag.name %}({{ ag.nick }}){% endif %}, {% endfor %}<br>
                    <b>Agents:</b> {% for ag in context_agent.related_all_agents %} {{ ag.name }} {% if not ag.nick == ag.name %}({{ ag.nick }}){% endif %}, {% endfor %}
                </div>
              </span>{% endif %}
              <span id="new_name"></span>
              &nbsp; <input style="display:inline; vertical-align:top; float:right; margin: 0px 0px 7px 5px;" type="submit" name="new_exchange" value="{% trans 'New Exchange' %}" class="btn btn-primary" />
            </form>

            <!-- <form id="exchangeTypeForm" style="display: inline;" method="POST" action="" >
                {% csrf_token %}
                <p style="line-height:32px; text-align:right;">&nbsp;{% trans "To create a new exchange Type, please request it to an Ocp admin." %} </p>
                {{ new_form.use_case }}
                &nbsp; <input style="display: inline; vertical-align: top;" type="submit" name="new-exchange-type" value="{% trans 'New Exchange Type' %}" class="btn btn-primary btn-mini" />
            </form> -->

            <div class="modal hide fade" id="addResourceTypeModal" tabindex="-1" role="dialog" aria-labelledby="commit" aria-hidden="true" style="">
              <div class="modal-dialog">
              <div class="modal-content">
              <div class="modal-header">
                <h3><span id="name_action">{% trans "Add a new " %}</span> {% trans "Resource Type:" %}</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form class="validateMe" id="resourceForm" enctype="multipart/form-data" action="{% url "new_resource_type" agent_id=context_agent.id %}" method="POST" >
                  {% csrf_token %}
                  {% for fil in Rtype_form %}
                    <div class="modal-field">
                      {% if not fil.name == 'edid' %}
                        <label>{{ fil.label }}:</label>
                      {% endif %}
                        {{ fil }}
                      {% if fil.help_text %}<br/><span class="helptext">{{ fil.help_text }}</span>{% endif %}
                    </div>
                  {% endfor %}
                  <!-- <input type="hidden" id="edid" name="edid" value="" /> -->
                  <input type="hidden" id="next" name="next" value="exchanges_all" />
                  <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                    <input type="submit" class="btn btn-primary" name="new_resource_type" value="{% trans 'Save' %}" />
                  </div>
                </form>
              </div>
              </div>
              </div>
            </div>
            <div class="modal hide fade" id="addSkillTypeModal" tabindex="-1" role="dialog" aria-labelledby="commit" aria-hidden="true"  style="">
              <div class="modal-dialog">
              <div class="modal-content">
              <div class="modal-header">
                <h3><span id="name_action">{% trans "Add a new" %}</span> {% trans "Skill Type:" %}</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form class="validateMe" id="skillForm" enctype="multipart/form-data" action="{% url "new_skill_type" agent_id=context_agent.id %}" method="POST" >
                  {% csrf_token %}
                  {% for fil in Stype_form %}
                    <div class="modal-field" {% if fil.name == 'verb' %} style="float:left; margin-right:15px;" {% endif %} >
                      {% if not fil.name == 'edid' %}
                        <label>{{ fil.label }}:</label>
                      {% endif %}
                        {{ fil }}
                      {% if fil.help_text %}<br/><span class="helptext">{{ fil.help_text }}</span>{% endif %}
                    </div>
                  {% endfor %}

                  <!-- <input type="hidden" id="edid" name="edid" value="" /> -->
                  <input type="hidden" id="next" name="next" value="exchanges_all" />
                  <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                    <input type="submit" class="btn btn-primary" name="new_skill_type" value="{% trans 'Save' %}" />
                  </div>
                </form>
              </div>
              </div>
              </div>
            </div>
            <div class="modal hide fade" id="editExchangeTypeModal" tabindex="-1" role="dialog" aria-labelledby="commit" aria-hidden="true"  style="">
              <div class="modal-dialog">
              <div class="modal-content">
              <div class="modal-header">
                <h3><span id="name_action">{% trans "Edit an " %}</span> {% trans "Exchange Type:" %}</h3>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form class="validateMe" id="exchangeTypeForm" enctype="multipart/form-data" action="" method="POST" >
                  {% csrf_token %}
                  {% for fil in ext_form %}
                    <div class="modal-field">
                      {% if not fil.name == 'edid' %}
                        <label>{{ fil.label }}:</label>
                      {% endif %}
                        {{ fil }}
                      {% if fil.help_text %}<br/><span class="helptext">{{ fil.help_text }}</span>{% endif %}
                    </div>
                  {% endfor %}
                  <!-- <input type="hidden" id="edid" name="edid" value="" /> -->
                  <input type="hidden" id="next" name="next" value="exchanges_all" />
                  <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                    <input type="submit" class="btn btn-primary" name="edit_exchange_type" value="{% trans 'Save' %}" />
                  </div>
                </form>
              </div>
              </div>
              </div>
            </div>

          </div>

          {% endif %}

      </div>
</div>
{% endblock %}

{% block extra_script %}
	<!-- <script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
  <script src="https://code.jquery.com/jquery-1.12.1.min.js"></script> -->
  <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
  <script src="{% static 'js/chosen.jquery.js' %}"></script>
  <script src="{% static 'js/jquery.fancytree-all.min.js' %}"></script>
  <script src="{% static 'js/ocp-trees.js' %}"></script>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/bs4/dt-1.10.21/b-1.6.2/b-colvis-1.6.2/b-html5-1.6.2/r-2.2.5/datatables.min.css"/>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/v/bs4/dt-1.10.21/b-1.6.2/b-colvis-1.6.2/b-html5-1.6.2/r-2.2.5/datatables.min.js"></script>

{% endblock %}

{% block extra_body %}
	{{ block.super }}

<script type="text/javascript">

  $(document).ready(function(){

    $("#exchanges").DataTable({
        stateSave: true,
        autoWidth: true,
        order: [[1, 'desc']],
        dom: '<"col"rf><"row no-gutters"<"bigbox"t>><"row"<"col"l><"col"p><"col"B>>', //'B<"clear">lfrtip',
        buttons: [
            'colvis',
            {
                extend: 'pdf',
                exportOptions: {
                    columns: ':visible'
                }
            },
            {
                extend: 'csv',
                exportOptions: {
                    columns: ':visible'
                }
            },
        ],
        "columnDefs": [
            {
                // The `data` parameter refers to the data for the cell (defined by the
                // `data` option, which defaults to the column being worked with, in
                // this case `data: 0`.
                "render": function ( data, type, row ) {
                    //arr = data.split(', ');
                    //if (arr.length == 2){
                    //    return arr[1]+', '+arr[0];
                    //} else {
                    //    return data +' ('+ row+')';
                    //}
                    return data
                },
                "targets": 1
            }
        ]
    });


    $( "#help" ).toggle( function(){
        $('#help-content').show("slide", { direction: "right" }, "slow" );
        $( "#help" ).text("Hide Help");
      }, function(){
        $('#help-content').hide("slide", { direction: "right" }, "slow");
        $( "#help" ).text("Show Help");
    });

		$('.date-entry').datepicker({ dateFormat: "yy-mm-dd" });

    $('#tabs').removeAttr('style').tabs({
      classes: {
        "ui-tabs": "",
        "ui-tabs-panel": "ui-corner-all infobox"
      },
      beforeActivate: function( event, ui ) {
        //alert(ui.oldPanel.find('.exchange_type_tree').length);//find('li span.fancytree-expanded').nextAll('ul').html());
        //ui.oldPanel.find('li span.fancytree-selected .fancytree-checkbox').click();
        //ui.oldPanel.find('li span.fancytree-expanded').nextAll('ul').hide();
        //ui.oldPanel.find('li span.fancytree-expanded .fancytree-expander').click();
        $('#id_exchange_type_chosen .search-choice .search-choice-close').click();
        //$('#id_exchange_type_chosen .search-field').blur().parent().parent().blur().prev().click();//.click();
        ui.oldPanel.parent().click();

        ui.oldPanel.find('.exchange_type_tree').first().fancytree("getRootNode").visit(function(node){
          if(node.isExpanded()){
            node.setExpanded(false, {noAnimation: true, noEvents: true}); //alert('node:'+node.title);
          }
          //return 'skip';
        });
      },
      activate: function( event, ui ) {
        //alert(ui.newTab.html());
        setTimeout( function(){
          //$('#id_exchange_type_chosen .search-field').blur().parent().parent().blur().prev().click();//.click();
          //ui.newTab.find('a').click();
          //alert('oldPanel:'+ui.oldPanel.find('.exchange_type_tree').first().fancytree("getRootNode"));

        }, 200);
      }
    });

    $(".list").hide();
    $(".showhide").click(function(event){
      var id = event.target.id;
      var listId = 'list-' + id.split('-')[1];
      $("[id^="+listId+"]").slideToggle(200);
      $(this).text($(this).text() == '(SHOW)' ? '(HIDE)' : '(SHOW)');
    });


    $('span.edit').each(function(){
      //$(this).html('<a href="#">'+$(this).text()+'</a>')
      //$(this).mousedown(function(){
      //  alert('Hau! '+$(this).attr('id'));
      //});
    });



    //   T R E E S ,   D R O P D O W N S   A N D   M O D A L S   in the ocp-trees.js file



    //   C A T E G O R I E S

		var selectedCats = "{{ selected_values }}";

		$('.category').each(function(){
			var cat = $(this)[0];
      if (selectedCats.indexOf(cat.name+',') > -1 || selectedCats.indexOf(','+cat.name) > -1 || selectedCats == cat.name ) {
				$(this).prop('checked', true);
			}
		});

		$('.category').click(function()
		{
			var checkedCats = [];
			var checkedBox = $(this)[0];
			var allBox = $('#all')[0];
			if (checkedBox == allBox)
			{
				$('.category').each(function()
				{
		            $(this).prop('checked', false);
				});
				$('#all').prop('checked', true);
				checkedCats.push('all');
			}
			else
			{
				$('#all').prop('checked', false);
				$('.category').each(function()
				{
					var cat = $(this)[0];
		            if (cat.checked)
					{
						checkedCats.push(cat.value);
					}
				});
			}
			$('#categories').prop('value', checkedCats);
		});


  }); // end document.ready
</script>

{% endblock %}
